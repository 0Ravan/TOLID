<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت تولید پیشرفته</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDip8Z7tEGQh45-DUfuYpZQobK3AAGBW4o",
            authDomain: "my-production-dashboard.firebaseapp.com",
            projectId: "my-production-dashboard",
            storageBucket: "my-production-dashboard.firebasestorage.app",
            messagingSenderId: "626829274209",
            appId: "1:626829274209:web:cd6b1ccc3b63df29b9ce20"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const dbDocRef = doc(db, "dashboardData", "mainState");

        window.firebaseServices = { db, auth, dbDocRef, setDoc, onSnapshot, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-glow: rgba(0, 170, 255, 0.5);
            --primary-color: #00aaff;
            --primary-hover: #007fbf;
            --secondary-color: #8a94a6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #e63946;
            --commission-color: #fd7e14;
            --tracking-color: #9d4edd;
            --inventory-color: #20c997;
            --materials-color: #d63384;
            
            --bg-primary: #11131e;
            --bg-secondary: #1c1f2e;
            --bg-tertiary: #2a2d3e;
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #f0f2f5;
            --text-secondary: #adb5bd;
            
            --font-main: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes backgroundPan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--bg-primary);
        }
        *::-webkit-scrollbar { width: 8px; }
        *::-webkit-scrollbar-track { background: var(--bg-primary); }
        *::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 10px; border: 2px solid var(--bg-primary); }

        body { 
            font-family: var(--font-main); 
            background: var(--bg-primary);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #2a2d3e 100%);
            animation: backgroundPan 30s linear infinite;
            margin: 0; 
            padding: 20px; 
            color: var(--text-primary); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }

        .container { 
            max-width: 1600px; 
            margin: auto; 
            background: var(--bg-secondary); 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            border: 1px solid var(--border-color);
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        h1, h2, h3 { 
            color: var(--text-primary); 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 12px; 
            margin-top: 20px; 
        }
        h1 { font-size: 28px; font-weight: 600; } 
        h2 { font-size: 24px; font-weight: 500; } 
        h3 { font-size: 20px; margin-top: 30px; border-color: var(--secondary-color); font-weight: 500;}

        button { 
            font-family: var(--font-main); 
            color: white; 
            padding: 12px 24px; 
            border: 1px solid transparent; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 5px; 
            transition: all 0.3s ease;
            background-color: transparent;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        button:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-tertiary);
            border-radius: 8px;
            z-index: -1;
            transition: transform 0.3s ease;
            transform: scale(1);
        }
        button:hover:before {
            transform: scale(1.05);
        }
        button:hover {
            box-shadow: 0 0 15px var(--primary-glow);
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }
        button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.5;
            border-color: transparent;
        }

        .btn-primary { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-color); color: white; box-shadow: 0 0 20px var(--primary-glow); }
        .btn-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-color); color: white; box-shadow: 0 0 20px rgba(230, 57, 70, 0.5); }
        .btn-success { border-color: var(--success-color); color: var(--success-color); }
        .btn-success:hover { background-color: var(--success-color); color: white; }
        .btn-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .btn-warning:hover { background-color: var(--warning-color); color: var(--bg-primary); }
        .btn-commission { border-color: var(--commission-color); color: var(--commission-color); }
        .btn-commission:hover { background-color: var(--commission-color); color: white; }
        .btn-tracking { border-color: var(--tracking-color); color: var(--tracking-color); }
        .btn-tracking:hover { background-color: var(--tracking-color); color: white; }
        .btn-inventory { border-color: var(--inventory-color); color: var(--inventory-color); }
        .btn-inventory:hover { background-color: var(--inventory-color); color: var(--bg-primary); }
        .btn-materials { border-color: var(--materials-color); color: var(--materials-color); }
        .btn-materials:hover { background-color: var(--materials-color); color: white; }
        .btn-secondary { border-color: var(--secondary-color); color: var(--secondary-color); }
        .btn-secondary:hover { background-color: var(--secondary-color); color: white; }

        .hidden { display: none; }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            font-size: 14px; 
        }
        th, td { 
            padding: 14px; 
            text-align: right; 
            border-bottom: 1px solid var(--border-color); 
            vertical-align: middle; 
            transition: background-color 0.3s ease;
        }
        th { 
            background-color: rgba(0, 170, 255, 0.1);
            color: var(--primary-color); 
            font-weight: 600;
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        tr:hover td { background-color: rgba(255, 255, 255, 0.05); }

        .page-view { 
            margin-top: 30px; 
            border-top: 1px solid var(--border-color); 
            padding-top: 20px; 
            animation: fadeIn 0.4s ease-out;
        }

        .file-list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            margin-bottom: 12px; 
            transition: all 0.3s ease;
        }
        .file-list-item:hover {
            transform: translateX(-5px);
            border-color: var(--primary-color);
        }

        .filters, .bulk-update { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 20px; 
            padding: 20px; 
            background: rgba(0,0,0,0.2); 
            border-radius: 10px; 
            align-items: center; 
        }
        .filters label { font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .filters select, .filters input, .bulk-update select, .bulk-update button, #manualForm input, #manualForm select, textarea { 
            padding: 12px; 
            font-size: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-family: var(--font-main); 
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .filters select:focus, .filters input:focus, .bulk-update select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .status-ready { background-color: rgba(108, 117, 125, 0.1); }
        .status-inprogress { background-color: rgba(255, 193, 7, 0.1); }
        .status-inproduction { background-color: rgba(157, 78, 221, 0.1); }
        .status-printing { background-color: rgba(13, 202, 240, 0.1); }
        .status-printed { background-color: rgba(23, 162, 184, 0.2); }
        .status-done { background-color: rgba(25, 135, 84, 0.1); }
        .status-cancelled { background-color: rgba(220, 53, 69, 0.1); text-decoration: line-through; color: var(--text-secondary); }

        .summary-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .card { 
            background: var(--bg-tertiary); 
            padding: 25px; 
            border-radius: 12px; 
            text-align: center; 
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .card:before {
            content: '';
            position: absolute;
            top: 0; right: 0; width: 100%; height: 4px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .card h4 { margin: 0 0 15px; font-size: 16px; color: var(--text-secondary); font-weight: 500;}
        .card .count { font-size: 36px; font-weight: 700; color: var(--text-primary); }
        
        .card-total:before { background: var(--primary-color); }
        .card-ready:before { background: var(--secondary-color); }
        .card-inprogress:before { background: var(--warning-color); }
        .card-done:before { background: var(--success-color); }

        .nav-buttons { 
            margin-bottom: 25px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #auth-container { max-width: 400px; margin: auto; }
        #app-container { display: none; }
        .auth-form { display: flex; flex-direction: column; gap: 20px; }
        .auth-form input { padding: 14px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-tertiary); color: var(--text-primary); }
        .auth-toggle { text-align: center; margin-top: 20px; color: var(--primary-color); cursor: pointer; font-weight: 500;}
        #user-info { display: flex; align-items: center; gap: 15px; font-size: 14px; color: var(--text-secondary); }
        #logoutBtn { font-size: 13px; padding: 6px 12px; border-color: var(--danger-color); color: var(--danger-color); }
        #logoutBtn:hover { background-color: var(--danger-color); color: white; }

        /* Modal Styles */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; 
            z-index: 2000; opacity: 0; 
            transition: opacity 0.3s; pointer-events: none; 
        }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--bg-secondary); 
            padding: 35px; border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            width: 90%; max-width: 650px; 
            transform: scale(0.95); transition: transform 0.3s;
            display: flex; flex-direction: column; max-height: 90vh;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .modal-content h3 { flex-shrink: 0; margin-top: 0; border-color: var(--primary-color); }
        .modal-content p { margin: 15px 0; line-height: 1.7; color: var(--text-secondary); }
        .modal-buttons { text-align: left; margin-top: 30px; }
        .modal-form-group { margin: 20px 0; }
        .modal-form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-primary); }
        .modal-form-group input, .modal-form-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; font-family: var(--font-main); font-size: 15px; background: var(--bg-tertiary); color: var(--text-primary); }
        .modal-form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            align-items: flex-end;
        }
        #batchGroupWarning {
            background: rgba(255, 193, 7, 0.1); 
            border: 1px solid var(--warning-color); 
            border-radius: 10px; padding: 15px; 
        }
        #batchGroupWarning ul { padding-right: 20px; margin: 10px 0 0; }
        #manualForm { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }

        /* Edit Quantity Modal specific styles */
        #editQuantityModal .modal-content {
            max-width: 1000px;
            width: 90vw;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 30px;
            height: 80vh;
        }
        #editQuantityModal h3 {
             grid-column: 1 / -1;
        }
        #editQuantityList, .modal-right-panel {
            grid-row: 2 / 3;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
        }
        #editQuantityModal .modal-buttons {
            grid-column: 1 / -1;
            grid-row: 3 / 4;
            margin-top: 0;
            align-self: end;
        }
        #editQuantityList .modal-form-group { margin: 15px 0; }
        #inventoryWarningContainer h4 {
            margin-top: 0; color: var(--primary-color);
        }
        #inventoryWarningContainer h5 {
            margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; font-size: 16px; color: var(--text-secondary);
        }
        #inventoryWarningContainer p { margin: 8px 0; font-weight: 500; font-size: 14px; }
        .low-inventory { color: var(--danger-color); font-weight: bold; }
        
        /* Tracking & Report View Styles */
        .status-badge { padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; color: white; display: inline-block; }
        .status-badge-completed { background-color: var(--success-color); }
        .status-badge-inprogress { background-color: var(--warning-color); color: var(--bg-primary); }
        .status-badge-cancelled { background-color: var(--danger-color); }
        .status-badge-printing, .status-badge-tracking { background-color: var(--tracking-color); }
        .status-badge-printed { background-color: var(--primary-hover); }
        .status-badge-ready { background-color: var(--secondary-color); }

        .details-row { display: none; }
        .details-row.visible { display: table-row; }
        .details-cell { padding: 0 !important; }
        .details-content { 
            background-color: var(--bg-primary); 
            padding: 25px; 
            border: 2px solid var(--tracking-color); 
            animation: fadeIn 0.3s;
        }
        .details-content h4 { grid-column: 1 / -1; margin-top:0; color: var(--tracking-color); border-bottom: 1px solid var(--tracking-color); padding-bottom: 10px; }
        .stage-checklist { list-style: none; padding: 0; margin: 0; }
        .stage-checklist li { display: flex; align-items: center; font-size: 16px; margin-bottom: 12px; }
        .stage-checklist input[type="checkbox"] { 
            width: 22px; height: 22px; margin-left: 15px; cursor: pointer; 
            appearance: none; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 5px;
            transition: all 0.2s;
        }
        .stage-checklist input[type="checkbox"]:checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        #batchTrackingTableContainer table td button { padding: 6px 12px; font-size: 13px; }
        .has-batch-code { background-color: rgba(157, 78, 221, 0.1) !important; }
        
        .upload-area { 
            border: 2px dashed var(--border-color); 
            padding: 30px; border-radius: 12px; 
            text-align: center; margin-top: 20px; 
            background-color: rgba(0,0,0,0.2); 
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-tertiary);
        }
        .upload-area label {
             border-style: solid;
             background-color: var(--bg-tertiary);
        }

        #dataManagement { 
            border-top: 1px solid var(--border-color); 
            margin-top: 20px; padding-top: 20px; 
            display: flex; gap: 10px; justify-content: flex-end; align-items: center; 
        }

        .batch-group-item {
            background-color: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .batch-group-item h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .batch-group-item .modal-form-group {
            margin: 0;
        }
        
    </style>
</head>
<body>
    
    <div id="auth-container">
        <div class="container" style="max-width: 450px;">
            <h2 id="authTitle">ورود به داشبورد</h2>
            <div id="login-form" class="auth-form">
                <input type="email" id="loginEmail" placeholder="ایمیل" required>
                <input type="password" id="loginPassword" placeholder="رمز عبور" required>
                <button id="loginBtn" class="btn-primary" style="width: 100%; margin-top: 10px; background-color: var(--primary-color); color: white;">ورود</button>
            </div>
            <div id="signup-form" class="auth-form hidden">
                 <input type="email" id="signupEmail" placeholder="ایمیل" required>
                <input type="password" id="signupPassword" placeholder="رمز عبور" required>
                <button id="signupBtn" class="btn-primary" style="width: 100%; margin-top: 10px; background-color: var(--primary-color); color: white;">ثبت نام</button>
            </div>
             <p id="auth-toggle" class="auth-toggle">حساب کاربری ندارید؟ ثبت نام کنید</p>
        </div>
    </div>
    
    <div id="app-container" class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>داشبورد مدیریت تولید</h1>
             <div id="user-info">
                <span id="userEmail"></span>
                <button id="logoutBtn">خروج</button>
            </div>
        </div>
        <div id="dataManagement">
             <input type="file" id="importFile" class="hidden" accept=".json">
             <button id="exportDataBtn" class="btn-secondary">تهیه نسخه پشتیبان (Backup)</button>
             <button id="importDataBtn" class="btn-secondary">بازیابی اطلاعات (Restore)</button>
        </div>
        
        <div class="nav-buttons">
            <button id="showDashboardBtn" class="btn-primary">مدیریت فایل‌ها</button>
            <button id="showManualProductionBtn" class="btn-commission">تولید کارمزدی</button>
            <button id="showReportBtn" class="btn-success">گزارش جامع</button>
            <button id="showPrintingBtn" class="btn-inventory">در دست چاپ</button>
            <button id="showTrackingBtn" class="btn-tracking">رهگیری تولید</button>
            <button id="showInventoryBtn" class="btn-inventory">موجودی‌ها</button>
            <button id="showMaterialsBtn" class="btn-materials">استاندارد مواد</button>
        </div>

        <div id="dashboardView" class="page-view">
            <h2>بارگذاری و انتخاب فایل</h2>
            <div class="upload-area" style="border-color: var(--primary-color);">
                <input type="file" id="excelFile" class="hidden" accept=".xls,.xlsx,.csv" multiple>
                <label for="excelFile" class="btn-primary">بارگذاری فایل (های) جدید</label>
            </div>
            <div id="fileList" style="margin-top: 20px;"></div>
        </div>

        <div id="materialsView" class="page-view hidden">
            <h2>مدیریت مواد اولیه و استاندارد مصرف</h2>
             <div class="upload-area" style="border-color: var(--materials-color); margin-bottom: 30px;">
                <input type="file" id="materialsExcelFile" class="hidden" accept=".xls,.xlsx,.csv">
                <label for="materialsExcelFile" class="btn-materials">بارگذاری/افزودن اکسل مواد اولیه</label>
                 <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">فایل باید شامل ستون‌های 'نام مواد اولیه'، 'رنگ'، 'مقدار' و 'واحد سنجش' باشد. مقادیر به موجودی فعلی اضافه می‌شوند.</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3>تعریف/افزودن دستی مواد اولیه</h3>
                    <div class="filters">
                        <input type="text" id="materialName" placeholder="نام ماده اولیه" style="flex-grow: 2;">
                        <input type="text" id="materialColor" placeholder="رنگ ماده اولیه">
                        <input type="number" id="materialStock" placeholder="مقدار برای افزودن" min="0">
                         <select id="materialUnit">
                            <option value="">-- واحد --</option>
                            <option>عدد</option>
                            <option>کیلوگرم</option>
                            <option>گرم</option>
                            <option>بسته</option>
                            <option>طاقه</option>
                            <option>متر</option>
                            <option>سانتی متر</option>
                        </select>
                        <button id="addMaterialBtn" class="btn-primary">افزودن</button>
                    </div>
                    <div id="materialsTableContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div>
                    <h3>تعریف استاندارد مصرف (به ازای هر واحد محصول)</h3>
                     <div class="filters">
                        <select id="bomGroupSelect" style="flex-grow: 1;"></select>
                        <select id="bomMaterialSelect" style="flex-grow: 1;"></select>
                        <select id="bomMaterialColorSelect" style="flex-grow: 1;"></select>
                        <input type="number" id="bomConsumptionInput" placeholder="میزان مصرف" min="0" step="0.1">
                        <button id="addBomBtn" class="btn-materials">ثبت استاندارد</button>
                    </div>
                    <div id="bomTableContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>


        <div id="inventoryView" class="page-view hidden">
            <h2>مدیریت موجودی محصولات آماده</h2>
            <div class="upload-area" style="border-color: var(--inventory-color);">
                 <input type="file" id="inventoryExcelFile" class="hidden" accept=".xls,.xlsx,.csv">
                <label for="inventoryExcelFile" class="btn-inventory">بارگذاری/افزودن فایل موجودی</label>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">فایل اکسل باید شامل ستون‌های 'نام آیتم' و 'تعداد (- استرداد)' باشد. مقادیر به موجودی فعلی اضافه/کسر می‌شوند.</p>
            </div>
            <div id="inventoryTableContainer" style="margin-top: 20px;"></div>
        </div>

        <div id="manualProductionView" class="page-view hidden">
            <h2>ایجاد دستور تولید دستی (کارمزدی)</h2>
            <form id="manualForm" class="filters">
                <input type="text" id="manualProductName" placeholder="نام محصول">
                <input type="text" id="manualSku" placeholder="کد طرح">
                <input type="text" id="manualColor" placeholder="رنگ">
                <select id="manualSize">
                    <option value="">-- سایز --</option>
                    <option>S</option><option>M</option><option>L</option><option>XL</option>
                    <option>2XL</option><option>3XL</option><option>XS</option><option>تک سایز</option>
                </select>
                <input type="number" id="manualQuantity" placeholder="تعداد" min="1">
                 <select id="manualGroup">
                    <option value="">-- گروه محصول --</option>
                    <option>هودی</option><option>تیشرت</option><option>بامبر</option>
                    <option>دورس</option><option>شلوار</option><option>سویشرت</option><option>سایر</option>
                </select>
                <button type="button" id="addItemToManualListBtn" class="btn-primary" style="grid-column: 1 / -1;">افزودن آیتم</button>
            </form>
            <div id="manualItemsContainer" style="margin-top: 30px;">
                 <h3>لیست آیتم‌های دستور تولید فعلی</h3>
                 <div id="manualItemsTableContainer" style="max-height: 400px; overflow-y: auto;"><p>هنوز آیتمی اضافه نشده است.</p></div>
            </div>
            <div class="bulk-update" style="margin-top: 20px;">
                <button id="saveManualOrderBtn" class="btn-success">ذخیره و ارسال به گزارش جامع</button>
                <button id="clearManualOrderBtn" class="btn-danger">پاک کردن لیست فعلی</button>
            </div>
        </div>

        <div id="processingView" class="page-view hidden">
            <button id="backToDashboard" class="btn-secondary">بازگشت به لیست فایل‌ها</button>
            <h2 id="processingFileName"></h2>
            <h3>فیلتر و صدور دستور تولید</h3>
            <div class="filters">
                <label>گروه محصول: <select id="groupFilter"><option value="">همه</option></select></label>
                <label>فیلتر رنگ: <select id="colorFilter"><option value="">همه</option></select></label>
                <label>فیلتر سایز: <select id="sizeFilter"><option value="">همه</option></select></label>
                <label>وضعیت: <select id="processingStatusFilter">
                    <option value="">همه</option>
                    <option>آماده تولید</option>
                    <option>درحال انجام</option>
                    <option>در دست چاپ</option>
                    <option>چاپ شده</option>
                    <option>انجام شده</option>
                    <option>ابطال</option>
                </select></label>
                <button id="clearProcessingFiltersBtn" class="btn-secondary" style="margin-right: auto;">پاک کردن فیلترها</button>
            </div>
            <div class="bulk-update">
                <span>عملیات گروهی (برای موارد انتخابی):</span>
                <button id="createProductionOrderBtn" class="btn-success">صدور دستور تولید</button>
            </div>
            <div id="summaryCards" class="summary-cards"></div>
            <div id="tasksTableContainer" style="max-height: 600px; overflow-y: auto;"></div>
        </div>

        <div id="reportView" class="page-view hidden">
            <h2>بایگانی و رهگیری دستورات تولید</h2>
             <div class="filters">
                <label>فیلتر فایل: <select id="reportFileFilter"><option value="">همه فایل‌ها</option></select></label>
                <label>فیلتر وضعیت: <select id="reportStatusFilter">
                    <option value="">همه وضعیت‌ها</option>
                    <option value="درحال انجام">درحال انجام</option>
                    <option value="در حال تولید">در حال تولید</option>
                    <option value="در دست چاپ">در دست چاپ</option>
                    <option value="چاپ شده">چاپ شده</option>
                    <option value="انجام شده">انجام شده</option>
                    <option value="ابطال">ابطال</option>
                </select></label>
                <label>گروه محصول: <select id="reportGroupFilter"><option value="">همه گروه‌ها</option></select></label>
                <label>فیلتر رنگ: <select id="reportColorFilter"><option value="">همه رنگ‌ها</option></select></label>
                <label>فیلتر سایز: <select id="reportSizeFilter"><option value="">همه سایزها</option></select></label>
                <label>کد طرح: <input type="text" id="reportSkuSearch" placeholder="جستجوی کد طرح..."></label>
                <label>کد بچ: <input type="text" id="reportBatchSearch" placeholder="جستجوی کد بچ..."></label>
                <label>وضعیت کدبچ: 
                    <select id="reportBatchFilter">
                        <option value="">همه</option>
                        <option value="assigned">کد بچ دار</option>
                        <option value="unassigned">بدون کد بچ</option>
                    </select>
                </label>
                <button id="clearReportFiltersBtn" class="btn-secondary" style="margin-right: auto;">پاک کردن فیلترها</button>
            </div>
            <div class="bulk-update">
                <span>عملیات گروهی (برای موارد انتخابی):</span>
                <label>تغییر به: <select id="reportToStatus">
                    <option value="آماده تولید">بازگشت به آماده تولید</option>
                    <option value="درحال انجام">درحال انجام</option>
                    <option value="در حال تولید">در حال تولید</option>
                    <option value="در دست چاپ">در دست چاپ</option>
                    <option value="چاپ شده">چاپ شده</option>
                    <option value="انجام شده">انجام شده</option>
                    <option value="ابطال">ابطال</option>
                </select></label>
                <button id="reportBulkUpdateBtn" class="btn-warning">اعمال تغییر</button>
                <button id="sendToPrintingBtn" class="btn-inventory">ارسال برای چاپ</button>
                <button id="assignBatchCodeBtn" class="btn-primary">اختصاص کد بچ</button>
                <button id="exportReportBtn" class="btn-success">خروجی اکسل</button>
            </div>
            <div id="reportSummaryCards" class="summary-cards"></div>
            <div id="reportTableContainer" style="max-height: 700px; overflow-y: auto;"></div>
        </div>
        
        <div id="printingView" class="page-view hidden">
            <h2>مدیریت اقلام در دست چاپ</h2>
             <div class="filters">
                <label>فیلتر فایل: <select id="printingFileFilter"><option value="">همه فایل‌ها</option></select></label>
                <label>گروه محصول: <select id="printingGroupFilter"><option value="">همه گروه‌ها</option></select></label>
                <label>فیلتر رنگ: <select id="printingColorFilter"><option value="">همه رنگ‌ها</option></select></label>
                <label>فیلتر سایز: <select id="printingSizeFilter"><option value="">همه سایزها</option></select></label>
                <button id="clearPrintingFiltersBtn" class="btn-secondary" style="margin-right: auto;">پاک کردن فیلترها</button>
            </div>
            <div class="bulk-update">
                <span>عملیات گروهی (برای موارد انتخابی):</span>
                <button id="printingBulkUpdateBtn" class="btn-warning">تغییر وضعیت به چاپ شده</button>
                <button id="exportPrintingBtn" class="btn-success">خروجی اکسل</button>
                <button id="printPrintingBtn" class="btn-primary">چاپ لیست</button>
            </div>
            <div id="printingSummaryCards" class="summary-cards"></div>
            <div id="printingTableContainer" style="max-height: 700px; overflow-y: auto;"></div>
        </div>

        <div id="trackingView" class="page-view hidden">
            <h2>رهگیری مراحل تولید</h2>
            <div class="filters">
                <input type="text" id="trackingSearchInput" placeholder="جستجو بر اساس کد بچ...">
                <label>تاریخ ایجاد: <input type="date" id="trackingDateFilter"></label>
                <label>گروه محصول: <select id="trackingGroupFilter"><option value="">همه</option></select></label>
                <label>وضعیت: <select id="trackingStatusFilter"><option value="">همه</option><option value="completed">تکمیل شده</option><option value="inprogress">درحال انجام</option><option value="cancelled">کنسل شده</option></select></label>
                <button id="clearTrackingFiltersBtn" class="btn-secondary">پاک کردن فیلترها</button>
                <button id="exportTrackingBtn" class="btn-success" style="margin-right: auto;">خروجی اکسل</button>
            </div>
            <div id="batchTrackingTableContainer" style="max-height: 700px; overflow-y: auto;">
                <!-- Tracking table will be rendered here -->
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn-danger">تایید</button>
                <button id="modalCancelBtn" class="btn-secondary">لغو</button>
            </div>
        </div>
    </div>

    <div id="assignBatchModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="assignBatchModalTitle">اختصاص کد بچ و زمان تحویل</h3>
            
            <div id="multiBatchAssignmentContainer" class="hidden">
                <div id="batchAssignmentList" style="max-height: 400px; overflow-y: auto; margin-top: 15px; padding-right: 10px;">
                    <!-- JS will inject content here -->
                </div>
            </div>
            
            <div id="singleBatchAssignmentContainer">
                <p>یک کد بچ برای آیتم‌های انتخابی وارد کرده و تاریخ تحویل را مشخص کنید.</p>
                <div id="batchGroupWarning" class="modal-form-group hidden"></div>
                <div class="modal-form-row">
                    <div class="modal-form-group" style="margin: 0;">
                        <label for="batchCodeInput">کد بچ/سری:</label>
                        <input type="text" id="batchCodeInput" placeholder="کد به صورت خودکار تولید می‌شود" readonly>
                    </div>
                     <div class="modal-form-group" style="margin: 0;">
                        <label>تاریخ تحویل:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="batchDeliveryDay" style="width: 100%;"><option value="">روز</option></select>
                            <select id="batchDeliveryMonth" style="width: 100%;"><option value="">ماه</option></select>
                            <select id="batchDeliveryYear" style="width: 100%;"><option value="">سال</option></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="batchConfirmBtn" class="btn-success">تایید و اختصاص کد</button>
                <button id="batchCancelBtn" class="btn-secondary">لغو</button>
            </div>
        </div>
    </div>

    <div id="editQuantityModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>تغییر تعداد برای دستور تولید</h3>
            
            <!-- Left Panel: The scrollable list -->
            <div id="editQuantityList">
                <!-- Dynamic content will be injected here -->
            </div>
            
            <!-- Right Panel: Info and warnings -->
            <div class="modal-right-panel">
                <div id="inventoryWarningContainer">
                    <h4>آنالیز پیش از تولید</h4>
                    <div id="finishedGoodsWarning">
                         <h5>موجودی محصول آماده</h5>
                    </div>
                    <div id="rawMaterialsWarning">
                         <h5>موجودی مواد اولیه</h5>
                    </div>
                </div>
            </div>
            
            <!-- Buttons spanning both columns -->
            <div class="modal-buttons">
                <p>تعداد مورد نظر برای ارسال به خط تولید را مشخص کنید. مابقی در لیست "آماده تولید" باقی خواهد ماند.</p>
                <button id="quantityConfirmBtn" class="btn-success">تایید و ارسال</button>
                <button id="quantityCancelBtn" class="btn-secondary">لغو</button>
            </div>
        </div>
    </div>


<script type="module">
    document.addEventListener('DOMContentLoaded', () => {

    const { auth, dbDocRef, setDoc, onSnapshot, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } = window.firebaseServices;
    
    // --- State & Elements ---
    const elements = {
        authContainer: document.getElementById('auth-container'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        signupForm: document.getElementById('signup-form'),
        authToggle: document.getElementById('auth-toggle'),
        authTitle: document.getElementById('authTitle'),
        loginBtn: document.getElementById('loginBtn'),
        signupBtn: document.getElementById('signupBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        userEmail: document.getElementById('userEmail'),
        
        dashboardView: document.getElementById('dashboardView'), 
        processingView: document.getElementById('processingView'),
        manualProductionView: document.getElementById('manualProductionView'),
        reportView: document.getElementById('reportView'),
        printingView: document.getElementById('printingView'),
        trackingView: document.getElementById('trackingView'),
        inventoryView: document.getElementById('inventoryView'),
        materialsView: document.getElementById('materialsView'),
        excelFile: document.getElementById('excelFile'), fileList: document.getElementById('fileList'),
        backToDashboard: document.getElementById('backToDashboard'), processingFileName: document.getElementById('processingFileName'),
        groupFilter: document.getElementById('groupFilter'), colorFilter: document.getElementById('colorFilter'), sizeFilter: document.getElementById('sizeFilter'),
        processingStatusFilter: document.getElementById('processingStatusFilter'),
        tasksTableContainer: document.getElementById('tasksTableContainer'), summaryCards: document.getElementById('summaryCards'),
        createProductionOrderBtn: document.getElementById('createProductionOrderBtn'),
        showDashboardBtn: document.getElementById('showDashboardBtn'), 
        showReportBtn: document.getElementById('showReportBtn'),
        showManualProductionBtn: document.getElementById('showManualProductionBtn'),
        showPrintingBtn: document.getElementById('showPrintingBtn'),
        showTrackingBtn: document.getElementById('showTrackingBtn'),
        showInventoryBtn: document.getElementById('showInventoryBtn'),
        showMaterialsBtn: document.getElementById('showMaterialsBtn'),
        reportFileFilter: document.getElementById('reportFileFilter'), reportStatusFilter: document.getElementById('reportStatusFilter'),
        reportBulkUpdateBtn: document.getElementById('reportBulkUpdateBtn'), reportToStatus: document.getElementById('reportToStatus'),
        reportSummaryCards: document.getElementById('reportSummaryCards'), reportTableContainer: document.getElementById('reportTableContainer'),
        reportGroupFilter: document.getElementById('reportGroupFilter'),
        reportColorFilter: document.getElementById('reportColorFilter'),
        reportSizeFilter: document.getElementById('reportSizeFilter'),
        reportSkuSearch: document.getElementById('reportSkuSearch'),
        reportBatchSearch: document.getElementById('reportBatchSearch'),
        reportBatchFilter: document.getElementById('reportBatchFilter'),
        assignBatchCodeBtn: document.getElementById('assignBatchCodeBtn'),
        sendToPrintingBtn: document.getElementById('sendToPrintingBtn'),
        exportReportBtn: document.getElementById('exportReportBtn'),
        // Printing View Elements
        printingFileFilter: document.getElementById('printingFileFilter'),
        printingGroupFilter: document.getElementById('printingGroupFilter'),
        printingColorFilter: document.getElementById('printingColorFilter'),
        printingSizeFilter: document.getElementById('printingSizeFilter'),
        clearPrintingFiltersBtn: document.getElementById('clearPrintingFiltersBtn'),
        printingBulkUpdateBtn: document.getElementById('printingBulkUpdateBtn'),
        exportPrintingBtn: document.getElementById('exportPrintingBtn'),
        printPrintingBtn: document.getElementById('printPrintingBtn'),
        printingSummaryCards: document.getElementById('printingSummaryCards'),
        printingTableContainer: document.getElementById('printingTableContainer'),
        // Inventory Elements
        inventoryExcelFile: document.getElementById('inventoryExcelFile'),
        inventoryTableContainer: document.getElementById('inventoryTableContainer'),
        // Materials Elements
        materialsExcelFile: document.getElementById('materialsExcelFile'),
        materialName: document.getElementById('materialName'),
        materialColor: document.getElementById('materialColor'),
        materialStock: document.getElementById('materialStock'),
        materialUnit: document.getElementById('materialUnit'),
        addMaterialBtn: document.getElementById('addMaterialBtn'),
        materialsTableContainer: document.getElementById('materialsTableContainer'),
        bomGroupSelect: document.getElementById('bomGroupSelect'),
        bomMaterialSelect: document.getElementById('bomMaterialSelect'),
        bomMaterialColorSelect: document.getElementById('bomMaterialColorSelect'),
        bomConsumptionInput: document.getElementById('bomConsumptionInput'),
        addBomBtn: document.getElementById('addBomBtn'),
        bomTableContainer: document.getElementById('bomTableContainer'),
        // Manual Production Elements
        manualForm: document.getElementById('manualForm'),
        addItemToManualListBtn: document.getElementById('addItemToManualListBtn'),
        manualItemsTableContainer: document.getElementById('manualItemsTableContainer'),
        saveManualOrderBtn: document.getElementById('saveManualOrderBtn'),
        clearManualOrderBtn: document.getElementById('clearManualOrderBtn'),
        // Tracking View
        batchTrackingTableContainer: document.getElementById('batchTrackingTableContainer'),
        trackingSearchInput: document.getElementById('trackingSearchInput'),
        trackingDateFilter: document.getElementById('trackingDateFilter'),
        trackingGroupFilter: document.getElementById('trackingGroupFilter'),
        trackingStatusFilter: document.getElementById('trackingStatusFilter'),
        exportTrackingBtn: document.getElementById('exportTrackingBtn'),
        // Modals & Data Management
        importFile: document.getElementById('importFile'),
        importDataBtn: document.getElementById('importDataBtn'),
        exportDataBtn: document.getElementById('exportDataBtn'),
        confirmationModal: document.getElementById('confirmationModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalMessage: document.getElementById('modalMessage'),
        modalConfirmBtn: document.getElementById('modalConfirmBtn'),
        modalCancelBtn: document.getElementById('modalCancelBtn'),
        assignBatchModal: document.getElementById('assignBatchModal'),
        assignBatchModalTitle: document.getElementById('assignBatchModalTitle'),
        multiBatchAssignmentContainer: document.getElementById('multiBatchAssignmentContainer'),
        singleBatchAssignmentContainer: document.getElementById('singleBatchAssignmentContainer'),
        batchAssignmentList: document.getElementById('batchAssignmentList'),
        batchCodeInput: document.getElementById('batchCodeInput'),
        batchDeliveryYear: document.getElementById('batchDeliveryYear'),
        batchDeliveryMonth: document.getElementById('batchDeliveryMonth'),
        batchDeliveryDay: document.getElementById('batchDeliveryDay'),
        batchConfirmBtn: document.getElementById('batchConfirmBtn'),
        batchCancelBtn: document.getElementById('batchCancelBtn'),
        editQuantityModal: document.getElementById('editQuantityModal'),
        editQuantityList: document.getElementById('editQuantityList'),
        inventoryWarningContainer: document.getElementById('inventoryWarningContainer'),
        finishedGoodsWarning: document.getElementById('finishedGoodsWarning'),
        rawMaterialsWarning: document.getElementById('rawMaterialsWarning'),
        quantityConfirmBtn: document.getElementById('quantityConfirmBtn'),
        quantityCancelBtn: document.getElementById('quantityCancelBtn'),
        // Clear Filter Buttons
        clearProcessingFiltersBtn: document.getElementById('clearProcessingFiltersBtn'),
        clearReportFiltersBtn: document.getElementById('clearReportFiltersBtn'),
        clearTrackingFiltersBtn: document.getElementById('clearTrackingFiltersBtn'),
    };
    
    const defaultState = {
        files: {},
        productionLog: [],
        productionBatches: {},
        inventory: {}, // New structure: { 'GroupName': { 'Color': { 'Size': quantity } } }
        materials: {}, // { 'MaterialName': { 'Color': { stock, unit } } }
        bom: {}, // { 'GroupName': { 'MaterialName': { 'Color': consumption } } }
        fileCounter: 0,
        batchCounterA: 1,
        batchMonthA: '',
        batchCounterK: 1,
        batchMonthK: '',
        activeFileId: null,
    };

    let appState = { ...defaultState };
    let isInitialDataLoad = true; 
    let openTrackingDetails = new Set();


    const STATUSES = { 
        READY: 'آماده تولید', 
        IN_PROGRESS: 'درحال انجام', 
        IN_PRODUCTION: 'در حال تولید',
        PRINTING: 'در دست چاپ',
        PRINTED: 'چاپ شده',
        DONE: 'انجام شده',
        CANCELLED: 'ابطال'
    };
    const PRODUCTION_STAGES = {
        preparation: 'آماده سازی', patternMaking: 'الگو سازی', cutting: 'برش', sewing: 'دوخت',
        printing: 'چاپ و پرس', ironing: 'اتوکاری', packaging: 'بسته بندی', outsourcing: 'برون سپاری'
    };
    let manualOrderItems = [];
    let currentFilteredBatches = [];
    let currentBatchAssignment = { logIds: [], groups: {} };

    // --- Core Functions ---
    async function saveState() {
        if (window.firebaseServices && window.firebaseServices.setDoc) {
            try {
                // To prevent "circular structure" errors, we create a clean, deep-cloned version of the state
                // object before sending it to Firebase. This ensures that any non-serializable properties or
                // accidental circular references in the live appState object are removed.
                const cleanState = JSON.parse(JSON.stringify(appState));
                await window.firebaseServices.setDoc(window.firebaseServices.dbDocRef, cleanState);
            } catch (error) {
                console.error("Error during state serialization or saving to Firebase:", error);
                 // For debugging purposes, log the state object that caused the failure.
                console.log("State object that failed to save:", appState);
                showToast('خطا در ذخیره سازی اطلاعات. داده نامعتبر شناسایی شد.', 'error');
            }
        }
    }
    
    function initializeAppWithData(data) {
        appState = { ...defaultState, ...data };
        
        if (isInitialDataLoad) {
            renderDashboard();
            showView('dashboardView');
            isInitialDataLoad = false;
        } else {
            const visibleView = document.querySelector('.page-view:not(.hidden)');
            if (!visibleView) {
                renderDashboard();
                showView('dashboardView');
                return;
            }

            switch (visibleView.id) {
                case 'dashboardView':
                    renderDashboard();
                    break;
                case 'processingView':
                    if (appState.activeFileId && appState.files[appState.activeFileId]) {
                        renderProcessingView();
                    } else {
                        showView('dashboardView');
                        renderDashboard();
                    }
                    break;
                case 'reportView':
                    renderReportView();
                    break;
                case 'printingView':
                    renderPrintingView();
                    break;
                case 'trackingView':
                    renderTrackingView();
                    break;
                case 'inventoryView':
                    renderInventoryView();
                    break;
                case 'materialsView':
                    renderMaterialsView();
                    break;
            }
        }
    }
    
    // --- Auth Logic ---
    onAuthStateChanged(auth, user => {
        if (user) {
            isInitialDataLoad = true;
            elements.appContainer.style.display = 'block';
            elements.authContainer.style.display = 'none';
            elements.userEmail.textContent = user.email;
            onSnapshot(dbDocRef, (doc) => {
                if (doc.exists()) {
                    initializeAppWithData(doc.data());
                } else {
                    initializeAppWithData(defaultState);
                    saveState();
                }
            });
        } else {
            elements.appContainer.style.display = 'none';
            elements.authContainer.style.display = 'block';
        }
    });

    elements.authToggle.addEventListener('click', () => {
        const isLogin = elements.loginForm.classList.contains('hidden');
        elements.loginForm.classList.toggle('hidden');
        elements.signupForm.classList.toggle('hidden');
        elements.authTitle.textContent = isLogin ? 'ورود به داشبورد' : 'ایجاد حساب کاربری';
        elements.authToggle.textContent = isLogin ? 'حساب کاربری ندارید؟ ثبت نام کنید' : 'حساب کاربری دارید؟ وارد شوید';
    });

    elements.signupBtn.addEventListener('click', async () => {
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showToast('ثبت نام با موفقیت انجام شد.', 'success');
        } catch (error) {
            showToast(`خطا در ثبت نام: ${error.message}`, 'error');
        }
    });

    elements.loginBtn.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            showToast(`خطا در ورود: ${error.message}`, 'error');
        }
    });

    elements.logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            showToast(`خطا در خروج: ${error.message}`, 'error');
        }
    });


    // --- Modal Logic ---
    let onConfirmCallback = null;
    const showConfirmationModal = (title, message, onConfirm) => {
        elements.modalTitle.textContent = title;
        elements.modalMessage.innerHTML = message;
        onConfirmCallback = onConfirm;
        showModal(elements.confirmationModal);
    };

    const hideConfirmationModal = () => {
        hideModal(elements.confirmationModal);
        onConfirmCallback = null;
    };
    
    elements.modalConfirmBtn.addEventListener('click', () => {
        if (onConfirmCallback) {
            onConfirmCallback();
        }
        hideConfirmationModal();
    });

    elements.modalCancelBtn.addEventListener('click', hideConfirmationModal);

    const showModal = (modalElement) => modalElement.classList.remove('hidden');
    const hideModal = (modalElement) => modalElement.classList.add('hidden');
    elements.batchCancelBtn.addEventListener('click', () => hideModal(elements.assignBatchModal));
    elements.quantityCancelBtn.addEventListener('click', () => hideModal(elements.editQuantityModal));

    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `position: fixed; top: -100px; left: 50%; transform: translateX(-50%); color: white; padding: 15px 25px; border-radius: 8px; z-index: 3000; opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); box-shadow: 0 4px 15px rgba(0,0,0,0.2); background-color: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};`;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.top = '30px'; toast.style.opacity = '1'; }, 10);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.top = '-100px'; setTimeout(() => toast.remove(), 500); }, 4000);
    };

    const exportToExcel = (data, fileName) => {
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
        XLSX.writeFile(workbook, fileName);
    };

    const parseItemName = (itemName = '') => {
        let productName = itemName, color = 'نامشخص', size = 'تک سایز', productGroup = 'سایر';
        const knownSizes = ['S', 'M', 'L', 'XL', '2XL', '3XL', 'XXL', 'XS'];
        const sizeRegex = new RegExp(`\\b(${knownSizes.join('|')})\\b`, 'i');
        const groups = { 'هودی': 'هودی', 'تیشرت': 'تیشرت', 'بامبر': 'بامبر', 'دورس': 'دورس', 'شلوار': 'شلوار', 'سویشرت': 'سویشرت' };
        for (const key in groups) { if (itemName.includes(key)) { productGroup = groups[key]; break; } }
        const parts = productName.split(' - ');
        if (parts.length > 1) {
            productName = parts[0].trim();
            const details = parts[1].split(',').map(d => d.trim());
            let sizeFound = false;
            for (const detail of details) {
                const sizeMatch = detail.match(sizeRegex);
                if (sizeMatch && !sizeFound) { size = sizeMatch[0].toUpperCase(); sizeFound = true; } else { color = detail; }
            }
        }
        return { productName, color, size, productGroup };
    };
    
    // --- View Navigation ---
    const showView = (viewName) => {
        ['dashboardView', 'processingView', 'reportView', 'manualProductionView', 'printingView', 'trackingView', 'inventoryView', 'materialsView'].forEach(view => elements[view].classList.add('hidden'));
        elements[viewName].classList.remove('hidden');
    };
    elements.showDashboardBtn.addEventListener('click', () => showView('dashboardView'));
    elements.showManualProductionBtn.addEventListener('click', () => showView('manualProductionView'));
    elements.showReportBtn.addEventListener('click', () => { showView('reportView'); renderReportView(); });
    elements.showPrintingBtn.addEventListener('click', () => { showView('printingView'); renderPrintingView(); });
    elements.showTrackingBtn.addEventListener('click', () => { showView('trackingView'); renderTrackingView(); });
    elements.showInventoryBtn.addEventListener('click', () => { showView('inventoryView'); renderInventoryView(); });
    elements.showMaterialsBtn.addEventListener('click', () => { showView('materialsView'); renderMaterialsView(); });
    elements.backToDashboard.addEventListener('click', () => { appState.activeFileId = null; showView('dashboardView'); });

    // --- Data Management (Backup/Restore) ---
    elements.exportDataBtn.addEventListener('click', () => {
        try {
            const backupData = { ...appState };
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `production-dashboard-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('نسخه پشتیبان با موفقیت ایجاد شد.');
        } catch (err) {
            showToast(`خطا در ایجاد نسخه پشتیبان: ${err.message}`, 'error');
        }
    });
    
    elements.importDataBtn.addEventListener('click', () => elements.importFile.click());
    
    elements.importFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (!importedData.files || !importedData.productionLog) {
                    throw new Error('فایل پشتیبان معتبر نیست.');
                }
                showConfirmationModal('تایید بازیابی اطلاعات', 'آیا مطمئن هستید؟ تمام اطلاعات فعلی با اطلاعات فایل پشتیبان جایگزین خواهد شد. این عمل غیرقابل بازگشت است.', () => {
                    appState = importedData;
                    saveState();
                    showToast('اطلاعات با موفقیت بازیابی شد.');
                });
            } catch (err) {
                showToast(`خطا در بازیابی اطلاعات: ${err.message}`, 'error');
            } finally {
                e.target.value = ''; // Reset file input
            }
        };
        reader.readAsText(file);
    });


    // --- Dashboard View Logic ---
    const renderDashboard = () => {
        elements.fileList.innerHTML = '';
        if (Object.keys(appState.files).length === 0) {
            elements.fileList.innerHTML = '<p>هیچ فایلی برای نمایش وجود ندارد. لطفاً یک فایل جدید بارگذاری کنید.</p>'; return;
        }
        for (const fileId in appState.files) {
            const file = appState.files[fileId];
            const item = document.createElement('div');
            item.className = 'file-list-item';
            item.innerHTML = `<span><strong>(${file.shortId}) ${file.name}</strong></span><div><button class="btn-primary" data-id="${fileId}">مشاهده</button><button class="btn-danger" data-id="${fileId}">حذف</button></div>`;
            elements.fileList.appendChild(item);
        }
    };
    elements.fileList.addEventListener('click', (e) => {
        const fileId = e.target.dataset.id; if (!fileId) return;
        if (e.target.textContent === 'حذف') {
             showConfirmationModal(
                'تایید حذف فایل',
                `آیا از حذف فایل <strong>"${appState.files[fileId].name}"</strong> و تمام سوابق آن اطمینان دارید؟`,
                () => {
                    delete appState.files[fileId];
                    appState.productionLog = appState.productionLog.filter(log => log.sourceFileId !== fileId);
                    Object.keys(appState.productionBatches).forEach(batchCode => {
                        if(appState.productionBatches[batchCode].sourceFileId === fileId) delete appState.productionBatches[batchCode];
                    });
                    saveState(); 
                    showToast('فایل حذف شد.');
                }
            );
        } else if (e.target.textContent === 'مشاهده') {
            appState.activeFileId = fileId; showView('processingView'); renderProcessingView();
        }
    });
    elements.excelFile.addEventListener('change', (e) => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) throw new Error('فایل خالی است.');
                    appState.fileCounter++; const fileShortId = `F${appState.fileCounter}`; const fileId = `file_${Date.now()}`;
                    const tasks = {};
                    jsonData.forEach((row) => {
                        const { SKU } = row; if(!SKU) return;
                        const quantity = parseInt(row['تعداد (- استرداد)'], 10) || 0; if(quantity <= 0) return;
                        const { productName, color, size, productGroup } = parseItemName(row['نام آیتم']);
                        const taskKey = `${SKU}-${productName}-${color}-${size}`;
                        if (!tasks[taskKey]) {
                            tasks[taskKey] = { uniqueId: `${fileShortId}-${SKU}-${productName.replace(/\s/g, '')}-${color.replace(/\s/g, '')}-${size}`, sku: SKU, productName, color, size, productGroup, quantity: 0, status: STATUSES.READY };
                        }
                        tasks[taskKey].quantity += quantity;
                    });
                    appState.files[fileId] = { id: fileId, shortId: fileShortId, name: file.name, uploadDate: new Date().toLocaleDateString('fa-IR'), tasks: Object.values(tasks) };
                    saveState(); showToast(`فایل "${file.name}" بارگذاری شد.`);
                } catch (err) { showToast(`خطا در پردازش: ${err.message}`, 'error');}
            };
            reader.readAsArrayBuffer(file);
        }
        e.target.value = '';
    });
    
    // --- Materials View Logic ---
    const renderMaterialsView = () => {
        // Render Materials Table
        const materialNames = Object.keys(appState.materials);
        let materialsTable = '<table><thead><tr><th>ماده اولیه</th><th>رنگ</th><th>موجودی</th><th>واحد</th><th>حذف</th></tr></thead><tbody>';
        if(materialNames.length > 0) {
            materialNames.forEach(name => {
                Object.keys(appState.materials[name]).forEach(color => {
                    const material = appState.materials[name][color];
                    materialsTable += `<tr><td>${name}</td><td>${color}</td><td>${material.stock}</td><td>${material.unit}</td><td><button class="btn-danger btn-sm" data-delete-material-name="${name}" data-delete-material-color="${color}">X</button></td></tr>`;
                });
            });
        } else {
            materialsTable += '<tr><td colspan="5">هیچ ماده اولیه‌ای تعریف نشده است.</td></tr>';
        }
        elements.materialsTableContainer.innerHTML = materialsTable + '</tbody></table>';

        // Render BOM Table
        let bomTable = '<table><thead><tr><th>گروه محصول</th><th>ماده اولیه</th><th>رنگ</th><th>میزان مصرف</th><th>حذف</th></tr></thead><tbody>';
        const bomGroups = Object.keys(appState.bom);
        if(bomGroups.length > 0) {
            bomGroups.forEach(group => {
                Object.keys(appState.bom[group]).forEach(materialName => {
                    Object.keys(appState.bom[group][materialName]).forEach(color => {
                        bomTable += `<tr><td>${group}</td><td>${materialName}</td><td>${color}</td><td>${appState.bom[group][materialName][color]}</td><td><button class="btn-danger btn-sm" data-delete-bom-group="${group}" data-delete-bom-material="${materialName}" data-delete-bom-color="${color}">X</button></td></tr>`;
                    });
                });
            });
        } else {
            bomTable += '<tr><td colspan="5">هیچ استاندارد مصرفی تعریف نشده است.</td></tr>';
        }
        elements.bomTableContainer.innerHTML = bomTable + '</tbody></table>';
        
        // Populate dropdowns
        const predefinedGroups = ['هودی', 'تیشرت', 'بامبر', 'دورس', 'شلوار', 'سویشرت', 'سایر'];
        const allGroups = new Set(predefinedGroups);
        Object.values(appState.files).forEach(file => file.tasks.forEach(task => allGroups.add(task.productGroup)));
        elements.bomGroupSelect.innerHTML = '<option value="">-- گروه محصول --</option>' + [...allGroups].sort().map(g => `<option>${g}</option>`).join('');
        elements.bomMaterialSelect.innerHTML = '<option value="">-- ماده اولیه --</option>' + materialNames.sort().map(m => `<option>${m}</option>`).join('');
        elements.bomMaterialColorSelect.innerHTML = '<option value="">-- رنگ ماده --</option>'; // Populated on material change
    };

    elements.bomMaterialSelect.addEventListener('change', (e) => {
        const materialName = e.target.value;
        const colors = materialName && appState.materials[materialName] ? Object.keys(appState.materials[materialName]) : [];
        elements.bomMaterialColorSelect.innerHTML = '<option value="">-- رنگ ماده --</option>' + colors.sort().map(c => `<option>${c}</option>`).join('');
    });
    
    elements.addMaterialBtn.addEventListener('click', () => {
        const name = elements.materialName.value.trim();
        const color = elements.materialColor.value.trim();
        const stock = parseInt(elements.materialStock.value, 10);
        const unit = elements.materialUnit.value.trim();
        if(!name || !color || isNaN(stock) || stock < 0 || !unit) {
            showToast('نام، رنگ، موجودی و واحد معتبر وارد کنید.', 'error');
            return;
        }
        if (!appState.materials[name]) {
            appState.materials[name] = {};
        }
        if (appState.materials[name][color]) {
            appState.materials[name][color].stock += stock;
        } else {
            appState.materials[name][color] = { stock, unit };
        }
        saveState();
        elements.materialName.value = '';
        elements.materialColor.value = '';
        elements.materialStock.value = '';
        elements.materialUnit.value = '';
    });
    
    elements.materialsTableContainer.addEventListener('click', e => {
        const materialName = e.target.dataset.deleteMaterialName;
        const materialColor = e.target.dataset.deleteMaterialColor;
        if(materialName && materialColor){
            showConfirmationModal(
                'تایید حذف ماده اولیه', 
                `آیا از حذف ماده اولیه '${materialName} - ${materialColor}' و تمام استانداردهای مصرف آن اطمینان دارید؟`,
                () => {
                    delete appState.materials[materialName][materialColor];
                    if(Object.keys(appState.materials[materialName]).length === 0) {
                        delete appState.materials[materialName];
                    }
                    Object.keys(appState.bom).forEach(group => {
                        if(appState.bom[group][materialName] && appState.bom[group][materialName][materialColor]){
                            delete appState.bom[group][materialName][materialColor];
                             if(Object.keys(appState.bom[group][materialName]).length === 0) {
                                delete appState.bom[group][materialName];
                            }
                        }
                    });
                    saveState();
                    showToast(`ماده اولیه '${materialName} - ${materialColor}' حذف شد.`);
                }
            );
        }
    });

    elements.addBomBtn.addEventListener('click', () => {
        const group = elements.bomGroupSelect.value;
        const materialName = elements.bomMaterialSelect.value;
        const materialColor = elements.bomMaterialColorSelect.value;
        const consumption = parseFloat(elements.bomConsumptionInput.value);
        if(!group || !materialName || !materialColor || isNaN(consumption) || consumption <= 0){
            showToast('لطفا تمام فیلدهای استاندارد مصرف را به درستی پر کنید.', 'error');
            return;
        }
        if(!appState.bom[group]){
            appState.bom[group] = {};
        }
        if(!appState.bom[group][materialName]){
            appState.bom[group][materialName] = {};
        }
        appState.bom[group][materialName][materialColor] = consumption;
        saveState();
        elements.bomConsumptionInput.value = '';
    });

    elements.bomTableContainer.addEventListener('click', e => {
        const group = e.target.dataset.deleteBomGroup;
        const material = e.target.dataset.deleteBomMaterial;
        const color = e.target.dataset.deleteBomColor;
        if(group && material && color){
            showConfirmationModal(
                'تایید حذف استاندارد',
                `آیا از حذف این استاندارد مصرف اطمینان دارید؟`,
                 () => {
                    delete appState.bom[group][material][color];
                    if(Object.keys(appState.bom[group][material]).length === 0){
                        delete appState.bom[group][material];
                    }
                    if(Object.keys(appState.bom[group]).length === 0){
                        delete appState.bom[group];
                    }
                    saveState();
                 }
            );
        }
    });

    elements.materialsExcelFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) throw new Error('فایل خالی است.');
                let updatedCount = 0;
                jsonData.forEach(row => {
                    const name = row['نام مواد اولیه'];
                    const color = row['رنگ'] || 'نامشخص';
                    const stock = parseFloat(row['مقدار']);
                    const unit = row['واحد سنجش'];
                    if (name && !isNaN(stock) && unit) {
                        const materialName = name.trim();
                        const materialColor = color.trim();
                        if (!appState.materials[materialName]) {
                            appState.materials[materialName] = {};
                        }
                        if (appState.materials[materialName][materialColor]) {
                            appState.materials[materialName][materialColor].stock += stock;
                        } else {
                            appState.materials[materialName][materialColor] = { stock, unit: unit.trim() };
                        }
                        updatedCount++;
                    }
                });
                if (updatedCount > 0) {
                    saveState();
                    showToast(`${updatedCount} ماده اولیه با موفقیت اضافه/به‌روزرسانی شد.`);
                } else {
                     showToast('هیچ ردیف معتبری در فایل اکسل یافت نشد. ستون‌ها باید "نام مواد اولیه"، "رنگ"، "مقدار" و "واحد سنجش" باشند.', 'error');
                }
            } catch (err) {
                showToast(`خطا در پردازش فایل: ${err.message}`, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = '';
    });


    // --- Inventory View Logic ---
    const renderInventoryView = () => {
        elements.inventoryTableContainer.innerHTML = '';
        const inventoryGroups = Object.keys(appState.inventory);
        if (inventoryGroups.length === 0) {
            elements.inventoryTableContainer.innerHTML = '<p>موجودی انبار خالی است. لطفا فایل موجودی را بارگذاری کنید.</p>';
            return;
        }
        let tableHTML = '<h3>موجودی دقیق محصولات</h3><table><thead><tr><th>گروه محصول</th><th>رنگ</th><th>سایز</th><th>تعداد موجودی</th></tr></thead><tbody>';
        let hasItems = false;
        for (const group of inventoryGroups.sort()) {
            for (const color of Object.keys(appState.inventory[group]).sort()) {
                for (const size of Object.keys(appState.inventory[group][color]).sort()) {
                    const quantity = appState.inventory[group][color][size];
                    if (quantity > 0) {
                        tableHTML += `<tr><td>${group}</td><td>${color}</td><td>${size}</td><td><strong>${quantity}</strong></td></tr>`;
                        hasItems = true;
                    }
                }
            }
        }
        if (!hasItems) {
            elements.inventoryTableContainer.innerHTML = '<p>موجودی انبار خالی است.</p>';
            return;
        }
        tableHTML += '</tbody></table>';
        elements.inventoryTableContainer.innerHTML = tableHTML;
    };
    elements.inventoryExcelFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length === 0) throw new Error('فایل موجودی خالی است.');
                let updatedCount = 0;
                jsonData.forEach(row => {
                    const quantity = parseInt(row['تعداد (- استرداد)'], 10) || 0;
                    const itemName = row['نام آیتم'];
                    if (quantity !== 0 && itemName) {
                        const { productGroup, color, size } = parseItemName(itemName);
                        
                        if (!appState.inventory[productGroup]) {
                            appState.inventory[productGroup] = {};
                        }
                        if (!appState.inventory[productGroup][color]) {
                            appState.inventory[productGroup][color] = {};
                        }
                        
                        appState.inventory[productGroup][color][size] = (appState.inventory[productGroup][color][size] || 0) + quantity;
                        updatedCount++;
                    }
                });
                if (updatedCount > 0) {
                    saveState();
                    showToast('فایل موجودی با موفقیت بارگذاری و مقادیر به موجودی فعلی اضافه/کسر شد.');
                }
            } catch (err) {
                showToast(`خطا در پردازش فایل موجودی: ${err.message}`, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = '';
    });

    // --- Manual Production View ---
    const renderManualItemsTable = () => {
        if(manualOrderItems.length === 0) { elements.manualItemsTableContainer.innerHTML = '<p>هنوز آیتمی اضافه نشده است.</p>'; return; }
        let tableHTML = '<table><thead><tr><th>محصول</th><th>کد طرح</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>حذف</th></tr></thead><tbody>';
        manualOrderItems.forEach((item, index) => {
            tableHTML += `<tr><td>${item.productName}</td><td>${item.sku}</td><td>${item.color}</td><td>${item.size}</td><td>${item.quantity}</td><td><button class="btn-danger" data-index="${index}">X</button></td></tr>`;
        });
        elements.manualItemsTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };
    elements.addItemToManualListBtn.addEventListener('click', () => {
        const item = {
            productName: document.getElementById('manualProductName').value.trim(),
            sku: document.getElementById('manualSku').value.trim(),
            color: document.getElementById('manualColor').value.trim(),
            size: document.getElementById('manualSize').value,
            quantity: parseInt(document.getElementById('manualQuantity').value, 10),
            productGroup: document.getElementById('manualGroup').value,
        };
        if(!item.productName || !item.sku || !item.color || !item.size || !item.quantity || !item.productGroup) { showToast('لطفا تمام فیلدها را پر کنید.', 'error'); return; }
        manualOrderItems.push({ ...item, status: STATUSES.IN_PROGRESS });
        renderManualItemsTable(); elements.manualForm.reset();
    });
    elements.manualItemsTableContainer.addEventListener('click', (e) => {
        if(e.target.classList.contains('btn-danger')) {
            manualOrderItems.splice(parseInt(e.target.dataset.index, 10), 1); renderManualItemsTable();
        }
    });
    elements.saveManualOrderBtn.addEventListener('click', () => {
        if(manualOrderItems.length === 0) { showToast('هیچ آیتمی برای ذخیره وجود ندارد.', 'error'); return; }
        const orderId = `MANUAL-${Date.now()}`; const orderDate = new Date().toLocaleString('fa-IR');
        manualOrderItems.forEach(item => {
            appState.productionLog.push({ ...item, logId: `${orderId}-${item.sku}-${item.size}`, orderId, orderDate, sourceFileId: 'manual', sourceFileShortId: 'دستی' });
        });
        saveState(); showToast(`${manualOrderItems.length} آیتم دستی ذخیره شد.`); manualOrderItems = []; renderManualItemsTable();
    });
    elements.clearManualOrderBtn.addEventListener('click', () => {
        if(manualOrderItems.length > 0){
             showConfirmationModal(
                'پاک کردن لیست',
                'آیا از پاک کردن لیست فعلی اطمینان دارید؟',
                () => {
                    manualOrderItems = []; 
                    renderManualItemsTable();
                    showToast('لیست پاک شد.');
                }
            );
        }
    });

    // --- Processing View Logic (File based) ---
    const renderProcessingView = () => {
        const file = appState.files[appState.activeFileId];
        elements.processingFileName.textContent = `پردازش فایل: (${file.shortId}) ${file.name}`;
        const tasks = file.tasks;
        const groups = [...new Set(tasks.map(t=>t.productGroup))];
        const colors = [...new Set(tasks.map(t=>t.color))];
        const sizes = [...new Set(tasks.map(t=>t.size))];
        elements.groupFilter.innerHTML = '<option value="">همه</option>' + groups.map(g => `<option>${g}</option>`).join('');
        elements.colorFilter.innerHTML = '<option value="">همه</option>' + colors.map(c => `<option>${c}</option>`).join('');
        elements.sizeFilter.innerHTML = '<option value="">همه</option>' + sizes.map(s => `<option>${s}</option>`).join('');
        applyProcessingFilters();
    };
    const applyProcessingFilters = () => {
        if (!appState.activeFileId) return;
        const file = appState.files[appState.activeFileId];
        const group = elements.groupFilter.value, color = elements.colorFilter.value, size = elements.sizeFilter.value, status = elements.processingStatusFilter.value;
        const filtered = file.tasks.filter(t => (!group || t.productGroup === group) && (!color || t.color === color) && (!size || t.size === size) && (!status || t.status === status));
        filtered.sort((a, b) => (String(a.sku)).localeCompare(String(b.sku), undefined, { numeric: true }));
        renderTasksTable(filtered); renderSummaryCards(filtered, elements.summaryCards, 'فیلتر');
    };
    [elements.groupFilter, elements.colorFilter, elements.sizeFilter, elements.processingStatusFilter].forEach(el => el.addEventListener('change', applyProcessingFilters));

    const renderSummaryCards = (items, container, scope) => {
        const totals = { total: 0, [STATUSES.READY]: 0, [STATUSES.IN_PROGRESS]: 0, [STATUSES.PRINTING]: 0, [STATUSES.DONE]: 0, [STATUSES.CANCELLED]: 0 };
        items.forEach(item => {
            totals.total += item.quantity;
            if (totals[item.status] !== undefined) {
                totals[item.status] += item.quantity;
            }
        });
         container.innerHTML = `
            <div class="card card-total"><h4>کل آیتم‌های ${scope}</h4><div class="count">${totals.total}</div></div>
            <div class="card card-ready"><h4>${STATUSES.READY}</h4><div class="count">${totals[STATUSES.READY]}</div></div>
            <div class="card card-inprogress"><h4>${STATUSES.IN_PROGRESS}</h4><div class="count">${totals[STATUSES.IN_PROGRESS]}</div></div>
            <div class="card card-done"><h4>${STATUSES.DONE}</h4><div class="count">${totals[STATUSES.DONE]}</div></div>
        `;
    };

    const renderTasksTable = (tasks) => {
        let tableHTML = `<table><thead><tr><th><input type="checkbox" id="selectAllTasks"></th><th>کد طرح</th><th>محصول</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>گروه</th><th>وضعیت</th></tr></thead><tbody>`;
        tasks.forEach(task => {
            tableHTML += `<tr>
                <td><input type="checkbox" class="task-checkbox" data-id="${task.uniqueId}"></td>
                <td>${task.sku}</td><td>${task.productName}</td><td>${task.color}</td><td>${task.size}</td>
                <td>${task.quantity}</td><td>${task.productGroup}</td><td>${task.status}</td></tr>`;
        });
        elements.tasksTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };
    elements.tasksTableContainer.addEventListener('change', (e) => {
        if (e.target.id === 'selectAllTasks') {
            document.querySelectorAll('.task-checkbox').forEach(cb => cb.checked = e.target.checked);
        }
    });

    elements.createProductionOrderBtn.addEventListener('click', () => {
        const selectedIds = [...document.querySelectorAll('.task-checkbox:checked')].map(cb => cb.dataset.id);
        if (selectedIds.length === 0) { showToast('هیچ آیتمی برای صدور دستور انتخاب نشده است.', 'error'); return; }

        const file = appState.files[appState.activeFileId];
        const selectedTasks = selectedIds.map(id => file.tasks.find(t => t.uniqueId === id)).filter(t => t && t.status === STATUSES.READY);
        if (selectedTasks.length === 0) { showToast('فقط آیتم‌های با وضعیت "آماده تولید" قابل ارسال هستند.', 'error'); return; }

        let listHTML = '';
        selectedTasks.forEach(task => {
            listHTML += `<div class="modal-form-group">
                <label>${task.productName} - ${task.color} - ${task.size} (کد: ${task.sku})</label>
                <input type="number" data-task-id="${task.uniqueId}" value="${task.quantity}" min="0" max="${task.quantity}" class="quantity-input">
            </div>`;
        });
        elements.editQuantityList.innerHTML = listHTML;
        
        // Analyze inventory
        analyzePreProduction(selectedTasks);

        showModal(elements.editQuantityModal);
    });
    
    const analyzePreProduction = (tasks) => {
        const neededProducts = {};
        const neededMaterials = {};

        // 1. Calculate needed finished products
        tasks.forEach(task => {
            const key = `${task.productGroup}||${task.color}||${task.size}`;
            neededProducts[key] = (neededProducts[key] || 0) + task.quantity;
        });

        let finishedGoodsHTML = '<h5>موجودی محصول آماده</h5>';
        let hasFinishedGoodsWarning = false;
        Object.keys(neededProducts).forEach(key => {
            const [group, color, size] = key.split('||');
            const needed = neededProducts[key];
            const available = appState.inventory[group]?.[color]?.[size] || 0;
            const deficit = needed - available;
            if (deficit > 0) {
                 finishedGoodsHTML += `<p><strong>${group} - ${color} - ${size}:</strong> نیاز: ${needed} | موجودی: ${available} | <span class="low-inventory">کسری: ${deficit}</span></p>`;
                 hasFinishedGoodsWarning = true;
            } else {
                 finishedGoodsHTML += `<p><strong>${group} - ${color} - ${size}:</strong> نیاز: ${needed} | موجودی: ${available} | <span style="color: var(--success-color);">تامین</span></p>`;
            }
        });
        elements.finishedGoodsWarning.innerHTML = hasFinishedGoodsWarning ? finishedGoodsHTML : '<h5>موجودی محصول آماده</h5><p>تمام محصولات مورد نیاز در انبار موجود است.</p>';

        // 2. Calculate needed raw materials based on deficit
        Object.keys(neededProducts).forEach(key => {
             const [group, color, size] = key.split('||');
             const needed = neededProducts[key];
             const available = appState.inventory[group]?.[color]?.[size] || 0;
             const deficit = Math.max(0, needed - available);
             if(deficit > 0 && appState.bom[group]) {
                 Object.keys(appState.bom[group]).forEach(materialName => {
                     Object.keys(appState.bom[group][materialName]).forEach(materialColor => {
                         const consumption = appState.bom[group][materialName][materialColor];
                         const materialKey = `${materialName}||${materialColor}`;
                         neededMaterials[materialKey] = (neededMaterials[materialKey] || 0) + (deficit * consumption);
                     });
                 });
             }
        });
        
        let rawMaterialsHTML = '<h5>موجودی مواد اولیه</h5>';
        let hasRawMaterialsWarning = false;
        if(Object.keys(neededMaterials).length === 0){
             rawMaterialsHTML += '<p>نیازی به مواد اولیه جدید نیست یا استاندارد مصرف تعریف نشده است.</p>';
        } else {
            Object.keys(neededMaterials).forEach(key => {
                const [name, color] = key.split('||');
                const needed = neededMaterials[key];
                const available = appState.materials[name]?.[color]?.stock || 0;
                const unit = appState.materials[name]?.[color]?.unit || 'نامشخص';
                const deficit = needed - available;
                 if (deficit > 0) {
                    rawMaterialsHTML += `<p><strong>${name} - ${color}:</strong> نیاز: ${needed.toFixed(2)} ${unit} | موجودی: ${available} ${unit} | <span class="low-inventory">کسری: ${deficit.toFixed(2)} ${unit}</span></p>`;
                    hasRawMaterialsWarning = true;
                } else {
                    rawMaterialsHTML += `<p><strong>${name} - ${color}:</strong> نیاز: ${needed.toFixed(2)} ${unit} | موجودی: ${available} ${unit} | <span style="color: var(--success-color);">تامین</span></p>`;
                }
            });
        }
        elements.rawMaterialsWarning.innerHTML = rawMaterialsHTML;
    };
    
    elements.quantityConfirmBtn.addEventListener('click', () => {
        const file = appState.files[appState.activeFileId];
        const inputs = document.querySelectorAll('#editQuantityList .quantity-input');
        let itemsSent = 0;
        
        inputs.forEach(input => {
            const taskId = input.dataset.taskId;
            const quantityToSend = parseInt(input.value, 10);
            if (isNaN(quantityToSend) || quantityToSend <= 0) return;

            const originalTaskIndex = file.tasks.findIndex(t => t.uniqueId === taskId);
            if(originalTaskIndex === -1) return;
            
            const originalTask = file.tasks[originalTaskIndex];
            
            if(quantityToSend > originalTask.quantity) {
                showToast(`تعداد ارسالی برای ${originalTask.productName} بیشتر از موجودی است.`, 'error');
                return;
            }

            const newLogEntry = {
                ...originalTask,
                quantity: quantityToSend,
                status: STATUSES.IN_PROGRESS,
                logId: `${originalTask.uniqueId}-${Date.now()}`,
                sourceFileId: appState.activeFileId,
                sourceFileShortId: file.shortId,
                orderDate: new Date().toLocaleString('fa-IR')
            };
            appState.productionLog.push(newLogEntry);
            itemsSent++;

            if(quantityToSend < originalTask.quantity) {
                originalTask.quantity -= quantityToSend; // Reduce quantity of original task
            } else {
                originalTask.status = STATUSES.IN_PROGRESS; // If all quantity is sent, just update status
            }
        });

        if (itemsSent > 0) {
            saveState();
            showToast(`${itemsSent} دستور تولید با موفقیت صادر شد.`);
            hideModal(elements.editQuantityModal);
            applyProcessingFilters(); // Re-render to show updated quantities/statuses
        }
    });

    elements.clearProcessingFiltersBtn.addEventListener('click', () => {
        elements.groupFilter.value = '';
        elements.colorFilter.value = '';
        elements.sizeFilter.value = '';
        elements.processingStatusFilter.value = '';
        applyProcessingFilters();
    });

    // --- Report View Logic ---
    const renderReportView = () => {
        const logs = appState.productionLog;
        const allFiles = Object.values(appState.files).map(f => ({id: f.id, name: `(${f.shortId}) ${f.name}`}));
        allFiles.push({id: 'manual', name: 'کارمزدی'});
        elements.reportFileFilter.innerHTML = '<option value="">همه فایل‌ها</option>' + allFiles.map(f => `<option value="${f.id}">${f.name}</option>`).join('');

        const allGroups = [...new Set(logs.map(l => l.productGroup))];
        elements.reportGroupFilter.innerHTML = '<option value="">همه گروه‌ها</option>' + allGroups.map(g => `<option>${g}</option>`).join('');
        
        const allColors = [...new Set(logs.map(l => l.color))];
        elements.reportColorFilter.innerHTML = '<option value="">همه رنگ‌ها</option>' + allColors.map(c => `<option>${c}</option>`).join('');

        const allSizes = [...new Set(logs.map(l => l.size))];
        elements.reportSizeFilter.innerHTML = '<option value="">همه سایزها</option>' + allSizes.map(s => `<option>${s}</option>`).join('');

        applyReportFilters();
    };

    const applyReportFilters = () => {
        const file = elements.reportFileFilter.value, status = elements.reportStatusFilter.value, group = elements.reportGroupFilter.value;
        const color = elements.reportColorFilter.value, size = elements.reportSizeFilter.value;
        const skuSearch = elements.reportSkuSearch.value.trim().toLowerCase();
        const batchSearch = elements.reportBatchSearch.value.trim().toLowerCase();
        const batchFilter = elements.reportBatchFilter.value;

        const filtered = appState.productionLog.filter(log =>
            (!file || log.sourceFileId === file) &&
            (!status || log.status === status) &&
            (!group || log.productGroup === group) &&
            (!color || log.color === color) &&
            (!size || log.size === size) &&
            (!skuSearch || String(log.sku).toLowerCase().includes(skuSearch)) &&
            (!batchSearch || (log.batchCode && log.batchCode.toLowerCase().includes(batchSearch))) &&
            (batchFilter === '' || (batchFilter === 'assigned' && log.batchCode) || (batchFilter === 'unassigned' && !log.batchCode))
        );
        renderReportTable(filtered);
    };
    [elements.reportFileFilter, elements.reportStatusFilter, elements.reportGroupFilter, elements.reportColorFilter, elements.reportSizeFilter, elements.reportBatchFilter].forEach(el => el.addEventListener('change', applyReportFilters));
    [elements.reportSkuSearch, elements.reportBatchSearch].forEach(el => el.addEventListener('input', applyReportFilters));

    const getStatusClass = (status) => {
        switch (status) {
            case STATUSES.READY: return 'status-ready';
            case STATUSES.IN_PROGRESS: return 'status-inprogress';
            case STATUSES.IN_PRODUCTION: return 'status-inproduction';
            case STATUSES.PRINTING: return 'status-printing';
            case STATUSES.PRINTED: return 'status-printed';
            case STATUSES.DONE: return 'status-done';
            case STATUSES.CANCELLED: return 'status-cancelled';
            default: return '';
        }
    };
    
    const getStatusBadge = (status) => {
        let className = '';
        switch (status) {
            case STATUSES.DONE: className = 'status-badge-completed'; break;
            case STATUSES.IN_PROGRESS: className = 'status-badge-inprogress'; break;
            case STATUSES.IN_PRODUCTION: className = 'status-badge-tracking'; break;
            case STATUSES.CANCELLED: className = 'status-badge-cancelled'; break;
            case STATUSES.PRINTING: className = 'status-badge-printing'; break;
            case STATUSES.PRINTED: className = 'status-badge-printed'; break;
            case STATUSES.READY: className = 'status-badge-ready'; break;
        }
        return `<span class="status-badge ${className}">${status}</span>`;
    };

    const renderReportTable = (filteredLogs) => {
        filteredLogs.sort((a,b) => (b.orderDate || '').localeCompare(a.orderDate || ''));
        let tableHTML = `<table><thead><tr>
            <th><input type="checkbox" id="selectAllReport"></th>
            <th>کد بچ</th><th>کد طرح</th><th>محصول</th><th>رنگ</th><th>سایز</th>
            <th>تعداد</th><th>وضعیت</th><th>وضعیت چاپ</th><th>منبع</th><th>عملیات</th>
        </tr></thead><tbody>`;
        if (filteredLogs.length === 0) {
            tableHTML += '<tr><td colspan="11">هیچ موردی با این فیلترها یافت نشد.</td></tr>';
        } else {
            filteredLogs.forEach(log => {
                let mainStatus = log.status;
                let printingStatus = '';
                if (log.status === STATUSES.PRINTING || log.status === STATUSES.PRINTED) {
                    mainStatus = STATUSES.IN_PROGRESS;
                    printingStatus = log.status;
                }
                const statusClass = getStatusClass(log.status);
                const mainStatusBadge = getStatusBadge(mainStatus);
                const printingStatusBadge = printingStatus ? getStatusBadge(printingStatus) : '';
                const fileName = log.sourceFileId === 'manual' ? 'کارمزدی' : (appState.files[log.sourceFileId]?.name || 'نامشخص');
                
                tableHTML += `<tr class="${statusClass} ${log.batchCode ? 'has-batch-code' : ''}">
                    <td><input type="checkbox" class="report-checkbox" data-id="${log.logId}"></td>
                    <td>${log.batchCode || '-'}</td>
                    <td>${log.sku}</td>
                    <td>${log.productName}</td>
                    <td>${log.color}</td>
                    <td>${log.size}</td>
                    <td>${log.quantity}</td>
                    <td>${mainStatusBadge}</td>
                    <td>${printingStatusBadge}</td>
                    <td>${log.sourceFileShortId} (${fileName})</td>
                    <td><button class="btn-danger btn-sm" data-delete-log-id="${log.logId}">حذف</button></td>
                </tr>`;
            });
        }
        elements.reportTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };

    elements.reportTableContainer.addEventListener('click', (e) => {
        if(e.target.dataset.deleteLogId){
            const logId = e.target.dataset.deleteLogId;
            const log = appState.productionLog.find(l => l.logId === logId);
            showConfirmationModal(
                'تایید حذف',
                `آیا از حذف آیتم "${log.productName} - ${log.color}" اطمینان دارید؟`,
                () => {
                    appState.productionLog = appState.productionLog.filter(l => l.logId !== logId);
                    // Also remove from any batches if it exists
                     Object.keys(appState.productionBatches).forEach(batchCode => {
                        const batch = appState.productionBatches[batchCode];
                        const itemIndex = batch.logIds.indexOf(logId);
                        if(itemIndex > -1){
                            batch.logIds.splice(itemIndex, 1);
                        }
                     });
                    saveState();
                    showToast('آیتم حذف شد.');
                }
            );
        }
    });


    elements.reportTableContainer.addEventListener('change', (e) => {
        if (e.target.id === 'selectAllReport') {
            document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = e.target.checked);
        }
    });

    elements.reportBulkUpdateBtn.addEventListener('click', () => {
        const selectedIds = [...document.querySelectorAll('.report-checkbox:checked')].map(cb => cb.dataset.id);
        if (selectedIds.length === 0) { showToast('هیچ آیتمی انتخاب نشده است.', 'error'); return; }
        const newStatus = elements.reportToStatus.value;
        let updatedCount = 0;
        selectedIds.forEach(id => {
            const log = appState.productionLog.find(l => l.logId === id);
            if (log) {
                 // Logic for returning to 'Ready'
                if (newStatus === STATUSES.READY) {
                    if (log.sourceFileId !== 'manual') {
                        const originalFile = appState.files[log.sourceFileId];
                        const originalTask = originalFile.tasks.find(t => t.uniqueId.startsWith(log.uniqueId.split('-')[0]));
                        if (originalTask) {
                            if (originalTask.status !== STATUSES.READY) {
                                originalTask.quantity += log.quantity;
                                originalTask.status = STATUSES.READY;
                            } else {
                                originalTask.quantity += log.quantity;
                            }
                            appState.productionLog = appState.productionLog.filter(l => l.logId !== id);
                            updatedCount++;
                        }
                    } else {
                        // Cannot return manual orders to ready, so we just update its status
                         log.status = newStatus;
                         updatedCount++;
                    }
                } else {
                    log.status = newStatus;
                    updatedCount++;
                }
            }
        });
        if (updatedCount > 0) { saveState(); showToast(`${updatedCount} آیتم به‌روزرسانی شد.`); }
    });
    
    elements.sendToPrintingBtn.addEventListener('click', () => {
        const selectedIds = [...document.querySelectorAll('.report-checkbox:checked')].map(cb => cb.dataset.id);
        if (selectedIds.length === 0) { showToast('هیچ آیتمی انتخاب نشده است.', 'error'); return; }
        
        let updatedCount = 0;
        selectedIds.forEach(id => {
            const log = appState.productionLog.find(l => l.logId === id);
            if(log && (log.status === STATUSES.IN_PROGRESS || log.status === STATUSES.IN_PRODUCTION)){
                log.status = STATUSES.PRINTING;
                updatedCount++;
            }
        });

        if (updatedCount > 0) {
            saveState();
            showToast(`${updatedCount} آیتم برای چاپ ارسال شد.`);
        } else {
            showToast('هیچ آیتم واجد شرایطی (وضعیت درحال انجام یا در حال تولید) برای ارسال یافت نشد.', 'error');
        }
    });

    elements.assignBatchCodeBtn.addEventListener('click', () => {
        const selectedIds = [...document.querySelectorAll('.report-checkbox:checked')].map(cb => cb.dataset.id);
        if (selectedIds.length === 0) { showToast('هیچ آیتمی برای اختصاص کد بچ انتخاب نشده است.', 'error'); return; }
        
        const selectedLogs = selectedIds.map(id => appState.productionLog.find(l => l.logId === id)).filter(Boolean);
        const eligibleLogs = selectedLogs.filter(log => [STATUSES.IN_PROGRESS, STATUSES.PRINTING, STATUSES.PRINTED, STATUSES.IN_PRODUCTION].includes(log.status) && !log.batchCode);
        
        if (eligibleLogs.length === 0) {
            showToast('هیچ آیتم واجد شرایطی (درحال انجام، در دست چاپ، چاپ شده، یا در حال تولید و بدون کد بچ) برای اختصاص کد یافت نشد.', 'error');
            return;
        }

        currentBatchAssignment.logIds = eligibleLogs.map(l => l.logId);
        
        const groups = {};
        eligibleLogs.forEach(log => {
            const key = log.productGroup;
            if(!groups[key]) groups[key] = [];
            groups[key].push(log.logId);
        });
        currentBatchAssignment.groups = groups;

        const groupKeys = Object.keys(groups);
        if(groupKeys.length > 1){
            // Multi-group assignment
            elements.singleBatchAssignmentContainer.classList.add('hidden');
            elements.multiBatchAssignmentContainer.classList.remove('hidden');
            elements.assignBatchModalTitle.textContent = "اختصاص کد بچ گروهی";
            
            let listHTML = '';
            groupKeys.forEach((groupName, index) => {
                const batchType = (groupName === 'هودی' || groupName === 'بامبر' || groupName === 'دورس') ? 'K' : 'A';
                 const batchCode = generateBatchCode(batchType, true); // Preview code
                listHTML += `
                    <div class="batch-group-item">
                        <h4>گروه: ${groupName}</h4>
                         <div class="modal-form-row">
                            <div class="modal-form-group">
                                <label>کد بچ/سری:</label>
                                <input type="text" data-group-key="${groupName}" class="multi-batch-code-input" value="${batchCode}" readonly>
                            </div>
                             <div class="modal-form-group">
                                <label>تاریخ تحویل:</label>
                                <div style="display: flex; gap: 10px;">
                                    <select data-group-key="${groupName}" class="multi-batch-day"><option value="">روز</option></select>
                                    <select data-group-key="${groupName}" class="multi-batch-month"><option value="">ماه</option></select>
                                    <select data-group-key="${groupName}" class="multi-batch-year"><option value="">سال</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            elements.batchAssignmentList.innerHTML = listHTML;
            document.querySelectorAll('.multi-batch-day, .multi-batch-month, .multi-batch-year').forEach(select => {
                 if(select.classList.contains('multi-batch-day')) populateDateSelect(select, 1, 31);
                 if(select.classList.contains('multi-batch-month')) populateDateSelect(select, 1, 12);
                 if(select.classList.contains('multi-batch-year')) populateDateSelect(select, 1403, 1410);
            });
        } else {
            // Single-group assignment
            elements.multiBatchAssignmentContainer.classList.add('hidden');
            elements.singleBatchAssignmentContainer.classList.remove('hidden');
            elements.assignBatchModalTitle.textContent = "اختصاص کد بچ و زمان تحویل";
            const batchType = (groupKeys[0] === 'هودی' || groupKeys[0] === 'بامبر' || groupKeys[0] === 'دورس') ? 'K' : 'A';
            elements.batchCodeInput.value = generateBatchCode(batchType);
        }
        
        populateDateSelect(elements.batchDeliveryDay, 1, 31);
        populateDateSelect(elements.batchDeliveryMonth, 1, 12);
        populateDateSelect(elements.batchDeliveryYear, 1403, 1410);
        showModal(elements.assignBatchModal);
    });

    const populateDateSelect = (select, start, end) => {
        const currentValue = select.value;
        let options = `<option value="">${select.id.includes('Day') ? 'روز' : select.id.includes('Month') ? 'ماه' : 'سال'}</option>`;
        for(let i = start; i <= end; i++) {
            options += `<option value="${i}">${i}</option>`;
        }
        select.innerHTML = options;
        select.value = currentValue;
    };
    
    const generateBatchCode = (type, isPreview = false) => {
        const today = new Date();
        const shamsiDate = today.toLocaleDateString('fa-IR-u-nu-latn').split('/');
        const shamsiMonth = parseInt(shamsiDate[1], 10);
        const shamsiDay = parseInt(shamsiDate[2], 10);

        const counterKey = `batchCounter${type}`;
        const monthKey = `batchMonth${type}`;

        if (appState[monthKey] !== shamsiMonth) {
            if(!isPreview) {
                appState[monthKey] = shamsiMonth;
                appState[counterKey] = 1;
            } else {
                 return `${type}${shamsiDay}${shamsiMonth}1`;
            }
        }
        
        const code = `${type}${shamsiDay}${shamsiMonth}${appState[counterKey]}`;
        
        if(!isPreview) {
            appState[counterKey]++;
        }
        return code;
    };
    
    elements.batchConfirmBtn.addEventListener('click', () => {
        let allValid = true;
        
        if(elements.singleBatchAssignmentContainer.classList.contains('hidden')){ // Multi-group mode
            const groupKeys = Object.keys(currentBatchAssignment.groups);
            const batchData = {};

            groupKeys.forEach(groupKey => {
                const day = document.querySelector(`.multi-batch-day[data-group-key="${groupKey}"]`).value;
                const month = document.querySelector(`.multi-batch-month[data-group-key="${groupKey}"]`).value;
                const year = document.querySelector(`.multi-batch-year[data-group-key="${groupKey}"]`).value;
                const batchCode = document.querySelector(`.multi-batch-code-input[data-group-key="${groupKey}"]`).value;
                if (!day || !month || !year || !batchCode) { allValid = false; return; }
                
                batchData[groupKey] = {
                    batchCode,
                    deliveryDate: `${year}/${month}/${day}`
                };
            });
            if (!allValid) { showToast('لطفا تاریخ تحویل را برای همه گروه‌ها مشخص کنید.', 'error'); return; }

            Object.keys(batchData).forEach(groupKey => {
                const data = batchData[groupKey];
                const logIdsInGroup = currentBatchAssignment.groups[groupKey];
                
                if(!appState.productionBatches[data.batchCode]){
                    appState.productionBatches[data.batchCode] = { code: data.batchCode, creationDate: new Date().toISOString(), deliveryDate: data.deliveryDate, status: 'inprogress', logIds: logIdsInGroup, stages: {}, productGroup: groupKey };
                } else {
                    appState.productionBatches[data.batchCode].logIds.push(...logIdsInGroup);
                }

                logIdsInGroup.forEach(logId => {
                    const log = appState.productionLog.find(l => l.logId === logId);
                    if (log) {
                        log.batchCode = data.batchCode;
                        log.deliveryDate = data.deliveryDate;
                        log.status = STATUSES.IN_PRODUCTION;
                    }
                });
            });

        } else { // Single-group mode
            const day = elements.batchDeliveryDay.value; const month = elements.batchDeliveryMonth.value; const year = elements.batchDeliveryYear.value;
            if (!day || !month || !year) { showToast('لطفا تاریخ تحویل را کامل مشخص کنید.', 'error'); return; }
            const deliveryDate = `${year}/${month}/${day}`; const batchCode = elements.batchCodeInput.value;
            
            appState.productionBatches[batchCode] = { code: batchCode, creationDate: new Date().toISOString(), deliveryDate, status: 'inprogress', logIds: currentBatchAssignment.logIds, stages: {}, productGroup: Object.keys(currentBatchAssignment.groups)[0] };
            currentBatchAssignment.logIds.forEach(logId => {
                const log = appState.productionLog.find(l => l.logId === logId);
                if (log) {
                    log.batchCode = batchCode;
                    log.deliveryDate = deliveryDate;
                    log.status = STATUSES.IN_PRODUCTION;
                }
            });
        }
        
        saveState(); hideModal(elements.assignBatchModal);
        showToast('کد بچ با موفقیت به آیتم‌ها اختصاص داده شد.');
    });


    elements.clearReportFiltersBtn.addEventListener('click', () => {
        elements.reportFileFilter.value = '';
        elements.reportStatusFilter.value = '';
        elements.reportGroupFilter.value = '';
        elements.reportColorFilter.value = '';
        elements.reportSizeFilter.value = '';
        elements.reportBatchFilter.value = '';
        elements.reportSkuSearch.value = '';
        elements.reportBatchSearch.value = '';
        applyReportFilters();
    });

    elements.exportReportBtn.addEventListener('click', () => {
        const table = elements.reportTableContainer.querySelector('table');
        if(!table) { showToast('جدولی برای خروجی گرفتن وجود ندارد.', 'error'); return; }
        const data = [];
        const headers = [...table.querySelectorAll('thead th')].map(th => th.innerText).slice(1,-1); // skip checkbox and actions
        data.push(headers);
        table.querySelectorAll('tbody tr').forEach(row => {
            const rowData = [...row.querySelectorAll('td')].map(td => td.innerText).slice(1,-1);
            data.push(rowData);
        });
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
        XLSX.writeFile(workbook, 'Comprehensive_Report.xlsx');
    });

    // --- Printing View Logic ---
    const renderPrintingView = () => {
        const printingItems = appState.productionLog.filter(log => log.status === STATUSES.PRINTING || log.status === STATUSES.PRINTED);
        const allFiles = [...new Set(printingItems.map(item => item.sourceFileId))].map(id => {
            return id === 'manual' ? {id: 'manual', name: 'کارمزدی'} : {id, name: `(${appState.files[id]?.shortId}) ${appState.files[id]?.name}`};
        });
        elements.printingFileFilter.innerHTML = '<option value="">همه فایل‌ها</option>' + allFiles.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        const allGroups = [...new Set(printingItems.map(item => item.productGroup))];
        elements.printingGroupFilter.innerHTML = '<option value="">همه گروه‌ها</option>' + allGroups.map(g => `<option>${g}</option>`).join('');
        const allColors = [...new Set(printingItems.map(item => item.color))];
        elements.printingColorFilter.innerHTML = '<option value="">همه رنگ‌ها</option>' + allColors.map(g => `<option>${g}</option>`).join('');
        const allSizes = [...new Set(printingItems.map(item => item.size))];
        elements.printingSizeFilter.innerHTML = '<option value="">همه سایزها</option>' + allSizes.map(g => `<option>${g}</option>`).join('');
        
        applyPrintingFilters();
    };
    
    const applyPrintingFilters = () => {
        const file = elements.printingFileFilter.value;
        const group = elements.printingGroupFilter.value;
        const color = elements.printingColorFilter.value;
        const size = elements.printingSizeFilter.value;

        const filtered = appState.productionLog.filter(log =>
            (log.status === STATUSES.PRINTING || log.status === STATUSES.PRINTED) &&
            (!file || log.sourceFileId === file) &&
            (!group || log.productGroup === group) &&
            (!color || log.color === color) &&
            (!size || log.size === size)
        );
        renderPrintingTable(filtered);
    };
    [elements.printingFileFilter, elements.printingGroupFilter, elements.printingColorFilter, elements.printingSizeFilter].forEach(el => el.addEventListener('change', applyPrintingFilters));

    const renderPrintingTable = (items) => {
        let tableHTML = `<table><thead><tr>
            <th><input type="checkbox" id="selectAllPrinting"></th>
            <th>کد بچ</th><th>کد طرح</th><th>محصول</th><th>رنگ</th><th>سایز</th>
            <th>تعداد</th><th>وضعیت چاپ</th><th>منبع</th>
        </tr></thead><tbody>`;
        if (items.length > 0) {
            items.forEach(log => {
                const fileName = log.sourceFileId === 'manual' ? 'کارمزدی' : appState.files[log.sourceFileId]?.name || 'نامشخص';
                tableHTML += `<tr>
                    <td><input type="checkbox" class="printing-checkbox" data-id="${log.logId}"></td>
                    <td>${log.batchCode || '-'}</td>
                    <td>${log.sku}</td>
                    <td>${log.productName}</td>
                    <td>${log.color}</td>
                    <td>${log.size}</td>
                    <td>${log.quantity}</td>
                    <td>${getStatusBadge(log.status)}</td>
                    <td>${log.sourceFileShortId} (${fileName})</td>
                </tr>`;
            });
        } else {
            tableHTML += '<tr><td colspan="9">هیچ آیتمی در صف چاپ وجود ندارد.</td></tr>';
        }
        elements.printingTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };

    elements.clearPrintingFiltersBtn.addEventListener('click', () => {
        elements.printingFileFilter.value = '';
        elements.printingGroupFilter.value = '';
        elements.printingColorFilter.value = '';
        elements.printingSizeFilter.value = '';
        applyPrintingFilters();
    });

    elements.printingTableContainer.addEventListener('change', (e) => {
        if (e.target.id === 'selectAllPrinting') {
            document.querySelectorAll('.printing-checkbox').forEach(cb => cb.checked = e.target.checked);
        }
    });

    elements.printingBulkUpdateBtn.addEventListener('click', () => {
        const selectedIds = [...document.querySelectorAll('.printing-checkbox:checked')].map(cb => cb.dataset.id);
        if (selectedIds.length === 0) { showToast('هیچ آیتمی انتخاب نشده است.', 'error'); return; }
        
        let updatedCount = 0;
        selectedIds.forEach(id => {
            const log = appState.productionLog.find(l => l.logId === id);
            if (log && log.status === STATUSES.PRINTING) {
                log.status = STATUSES.PRINTED;
                updatedCount++;
            }
        });

        if(updatedCount > 0){
            saveState();
            showToast(`${updatedCount} آیتم به "چاپ شده" تغییر وضعیت یافت.`);
        } else {
            showToast('هیچ آیتمی در وضعیت "در دست چاپ" برای تغییر انتخاب نشده بود.', 'warning');
        }
    });

    elements.exportPrintingBtn.addEventListener('click', () => {
        const table = elements.printingTableContainer.querySelector('table');
        if(!table) { return; }
        const dataToExport = [];
        table.querySelectorAll('tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 1) { // Ensure it's not the "no items" row
                 dataToExport.push({
                    'کد طرح': cells[2].innerText,
                    'محصول': cells[3].innerText,
                    'رنگ': cells[4].innerText,
                    'سایز': cells[5].innerText,
                    'تعداد': cells[6].innerText,
                    'وضعیت': cells[7].innerText,
                    'منبع': cells[8].innerText,
                    'کد بچ': cells[1].innerText
                });
            }
        });
        if (dataToExport.length > 0) {
            exportToExcel(dataToExport, 'Printing_List.xlsx');
        }
    });

    elements.printPrintingBtn.addEventListener('click', () => {
        const tableContainer = elements.printingTableContainer;
        const table = tableContainer.querySelector('table');
        if (!table) return;

        // Aggregate data
        const aggregatedData = {};
        table.querySelectorAll('tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
             if (cells.length > 1) {
                 const group = cells[3].innerText.split(' ')[0] || 'سایر'; // Simple grouping by first word
                 const color = cells[4].innerText;
                 const size = cells[5].innerText;
                 const quantity = parseInt(cells[6].innerText, 10);
                 const key = `${group}|${color}|${size}`;
                 aggregatedData[key] = (aggregatedData[key] || 0) + quantity;
             }
        });

        let printContent = `
            <style>
                body { font-family: 'Vazirmatn', sans-serif; direction: rtl; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }
                th { background-color: #f2f2f2; }
                h1 { text-align: center; }
            </style>
            <h1>لیست چاپ - ${new Date().toLocaleDateString('fa-IR')}</h1>
            <table><thead><tr><th>گروه محصول</th><th>رنگ</th><th>سایز</th><th>تعداد کل</th></tr></thead><tbody>`;
        
        Object.keys(aggregatedData).sort().forEach(key => {
            const [group, color, size] = key.split('|');
            const quantity = aggregatedData[key];
            printContent += `<tr><td>${group}</td><td>${color}</td><td>${size}</td><td>${quantity}</td></tr>`;
        });
        
        printContent += `</tbody></table>`;
        
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    });

    // --- Tracking View Logic ---
    const renderTrackingView = (keepOpenDetails = false) => {
        if(!keepOpenDetails) {
            openTrackingDetails.clear();
        }
        currentFilteredBatches = Object.values(appState.productionBatches);
        applyTrackingFilters(true);
    };

    const applyTrackingFilters = (isInitialRender = false) => {
        const searchTerm = elements.trackingSearchInput.value.toLowerCase();
        const dateFilter = elements.trackingDateFilter.value;
        const groupFilter = elements.trackingGroupFilter.value;
        const statusFilter = elements.trackingStatusFilter.value;
        
        currentFilteredBatches = Object.values(appState.productionBatches).filter(batch => {
            const creationDate = batch.creationDate.split('T')[0];
            return (!searchTerm || batch.code.toLowerCase().includes(searchTerm)) &&
                   (!dateFilter || creationDate === dateFilter) &&
                   (!groupFilter || batch.productGroup === groupFilter) &&
                   (!statusFilter || batch.status === statusFilter);
        });

        currentFilteredBatches.sort((a,b) => b.creationDate.localeCompare(a.creationDate));

        // Populate filters on initial render
        if(isInitialRender){
            const allGroups = [...new Set(Object.values(appState.productionBatches).map(b => b.productGroup))];
            elements.trackingGroupFilter.innerHTML = '<option value="">همه</option>' + allGroups.map(g => `<option>${g}</option>`).join('');
        }

        renderBatchTrackingTable(currentFilteredBatches);
    };
    [elements.trackingSearchInput, elements.trackingDateFilter, elements.trackingGroupFilter, elements.trackingStatusFilter].forEach(el => el.addEventListener('input', () => applyTrackingFilters()));

    const renderBatchTrackingTable = (batches) => {
        let tableHTML = `<table><thead><tr>
            <th>کد بچ</th><th>گروه محصول</th><th>تاریخ ایجاد</th><th>تاریخ تحویل</th><th>تعداد کل</th><th>وضعیت</th><th>مدت زمان</th><th>عملیات</th>
        </tr></thead><tbody>`;
        if (batches.length > 0) {
            batches.forEach(batch => {
                const totalQuantity = batch.logIds.reduce((sum, id) => {
                    const log = appState.productionLog.find(l => l.logId === id);
                    return sum + (log ? log.quantity : 0);
                }, 0);
                
                const startDate = new Date(batch.creationDate);
                const endDate = batch.completionDate ? new Date(batch.completionDate) : new Date();
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const duration = batch.status === 'completed' ? `${diffDays} روز و ${diffHours} ساعت` : 'درحال انجام';

                tableHTML += `
                    <tr data-batch-code="${batch.code}">
                        <td><strong>${batch.code}</strong></td>
                        <td>${batch.productGroup}</td>
                        <td>${new Date(batch.creationDate).toLocaleString('fa-IR')}</td>
                        <td>${batch.deliveryDate}</td>
                        <td>${totalQuantity}</td>
                        <td>${getStatusBadge(batch.status === 'completed' ? STATUSES.DONE : batch.status === 'cancelled' ? STATUSES.CANCELLED : STATUSES.IN_PROGRESS)}</td>
                        <td>${duration}</td>
                        <td>
                             <button class="btn-primary btn-sm" data-action="details">جزئیات</button>
                             <button class="btn-inventory btn-sm" data-action="print">چاپ</button>
                              ${batch.status !== 'completed' && batch.status !== 'cancelled' ? `<button class="btn-success btn-sm" data-action="complete">تکمیل بچ</button>` : ''}
                             ${batch.status !== 'completed' && batch.status !== 'cancelled' ? `<button class="btn-warning btn-sm" data-action="cancel">کنسل</button>` : ''}
                             ${batch.status !== 'completed' && batch.status !== 'cancelled' ? `<button class="btn-danger btn-sm" data-action="removeBatchCode">حذف بچ</button>` : ''}
                              ${batch.status === 'cancelled' ? `<button class="btn-danger btn-sm" data-action="delete">حذف</button>` : ''}
                        </td>
                    </tr>
                    <tr class="details-row ${openTrackingDetails.has(batch.code) ? 'visible' : ''}" data-details-for="${batch.code}">
                        <td colspan="8" class="details-cell"><div class="details-content">${renderBatchDetails(batch)}</div></td>
                    </tr>`;
            });
        } else {
            tableHTML += '<tr><td colspan="8">هیچ بچ تولیدی با این فیلترها یافت نشد.</td></tr>';
        }
        elements.batchTrackingTableContainer.innerHTML = tableHTML + '</tbody></table>';
    };

    const renderBatchDetails = (batch) => {
        const batchItems = batch.logIds.map(id => appState.productionLog.find(l => l.logId === id)).filter(Boolean);
        let itemsHTML = '<div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;"><ul>';
        batchItems.forEach(item => { itemsHTML += `<li>${item.productName} - ${item.color} - ${item.size} (تعداد: ${item.quantity})</li>`; });
        itemsHTML += '</ul></div>';
        
        let checklistHTML = '<ul class="stage-checklist">';
        Object.keys(PRODUCTION_STAGES).forEach(stageKey => {
            checklistHTML += `<li><input type="checkbox" data-batch-code="${batch.code}" data-stage="${stageKey}" ${batch.stages[stageKey] ? 'checked' : ''}> ${PRODUCTION_STAGES[stageKey]}</li>`;
        });
        checklistHTML += '</ul>';

        return `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div><h4>آیتم‌های بچ</h4>${itemsHTML}</div>
                    <div><h4>مراحل تولید</h4>${checklistHTML}</div>
                </div>`;
    };

    elements.batchTrackingTableContainer.addEventListener('click', (e) => {
        if(e.target.tagName !== 'BUTTON') return;
        const action = e.target.dataset.action;
        const batchCode = e.target.closest('tr').dataset.batchCode;
        if (!batchCode) return;
        
        switch(action) {
            case 'details': {
                const detailsRow = document.querySelector(`.details-row[data-details-for="${batchCode}"]`);
                if(detailsRow.classList.toggle('visible')){
                    openTrackingDetails.add(batchCode);
                } else {
                    openTrackingDetails.delete(batchCode);
                }
                break;
            }
            case 'complete': {
                 showConfirmationModal('تکمیل بچ تولید', `آیا از تکمیل بچ "${batchCode}" اطمینان دارید؟`, () => {
                    const batch = appState.productionBatches[batchCode];
                    if(batch){
                        batch.status = 'completed';
                        batch.completionDate = new Date().toISOString();
                        Object.keys(PRODUCTION_STAGES).forEach(stage => batch.stages[stage] = true); // Check all stages
                        
                        batch.logIds.forEach(logId => {
                            const log = appState.productionLog.find(l => l.logId === logId);
                            if(log) log.status = STATUSES.DONE;
                        });

                        saveState();
                        showToast(`بچ ${batchCode} تکمیل شد.`);
                    }
                });
                break;
            }
            case 'cancel': {
                showConfirmationModal('کنسل کردن بچ', `آیا از کنسل کردن بچ "${batchCode}" اطمینان دارید؟ وضعیت تمام آیتم های آن به "ابطال" تغییر خواهد کرد.`, () => {
                    const batch = appState.productionBatches[batchCode];
                    if(batch){
                        batch.status = 'cancelled';
                        batch.logIds.forEach(logId => {
                            const log = appState.productionLog.find(l => l.logId === id);
                            if(log) log.status = STATUSES.CANCELLED;
                        });
                        saveState();
                        showToast(`بچ ${batchCode} کنسل شد.`);
                    }
                });
                break;
            }
            case 'delete': {
                 showConfirmationModal('حذف بچ کنسل شده', `آیا از حذف بچ کنسل شده "${batchCode}" از لیست رهگیری اطمینان دارید؟ (سوابق آیتم‌ها باقی می‌ماند)`, () => {
                    delete appState.productionBatches[batchCode];
                    saveState();
                    showToast(`بچ ${batchCode} حذف شد.`);
                });
                break;
            }
             case 'removeBatchCode': {
                showConfirmationModal('حذف کد بچ', `آیا از حذف کد بچ "${batchCode}" از آیتم‌های مرتبط اطمینان دارید؟ وضعیت آیتم‌ها به "درحال انجام" بازمی‌گردد.`, () => {
                    const batch = appState.productionBatches[batchCode];
                    if (batch) {
                        batch.logIds.forEach(logId => {
                            const log = appState.productionLog.find(l => l.logId === logId);
                            if (log) {
                                log.batchCode = null;
                                log.deliveryDate = null;
                                // Only revert status if it's not in a printing state
                                if (log.status !== STATUSES.PRINTING && log.status !== STATUSES.PRINTED) {
                                    log.status = STATUSES.IN_PROGRESS;
                                }
                            }
                        });
                        delete appState.productionBatches[batchCode];
                        saveState();
                        showToast(`کد بچ ${batchCode} حذف و آیتم‌ها به‌روزرسانی شدند.`);
                    }
                });
                break;
            }
            case 'print': {
                const batch = appState.productionBatches[batchCode];
                if(batch) printBatch(batch);
                break;
            }
        }
    });

    const printBatch = (batch) => {
        const batchItems = batch.logIds.map(id => appState.productionLog.find(l => l.logId === id)).filter(Boolean);
        
        const aggregatedItems = {};
        batchItems.forEach(item => {
            const key = `${item.productGroup}|${item.color}|${item.size}`;
            aggregatedItems[key] = (aggregatedItems[key] || 0) + item.quantity;
        });

        let itemsContent = '<table><thead><tr><th>گروه</th><th>رنگ</th><th>سایز</th><th>تعداد</th></tr></thead><tbody>';
        let totalQuantity = 0;
        Object.keys(aggregatedItems).sort().forEach(key => {
            const [group, color, size] = key.split('|');
            const quantity = aggregatedItems[key];
            totalQuantity += quantity;
            itemsContent += `<tr><td>${group}</td><td>${color}</td><td>${size}</td><td>${quantity}</td></tr>`;
        });
        itemsContent += `<tr><td colspan="3"><strong>جمع کل</strong></td><td><strong>${totalQuantity}</strong></td></tr></tbody></table>`;

        let checklistContent = '<div class="checklist"><h4>چک لیست تولید</h4><ul>';
        Object.values(PRODUCTION_STAGES).forEach(stageName => {
            checklistContent += `<li><span class="checkbox"></span>${stageName}</li>`;
        });
        checklistContent += '</ul></div>';

        const printWindow = window.open('', '', 'height=800,width=1000');
        printWindow.document.write(`
            <html><head><title>چاپ دستور تولید</title>
            <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Vazirmatn', sans-serif; direction: rtl; padding: 20px; }
                .print-container { border: 2px solid #333; border-radius: 15px; padding: 30px; }
                h1 { text-align: center; font-size: 32px; margin-bottom: 5px; }
                .batch-code { text-align: center; font-size: 64px; font-weight: bold; margin: 10px 0 30px; letter-spacing: 2px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; font-size: 18px; }
                table { width: 100%; border-collapse: collapse; font-size: 16px; }
                th, td { border: 1px solid #ccc; padding: 12px; text-align: right; }
                th { background-color: #f2f2f2; }
                .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; }
                .checklist ul { list-style: none; padding: 0; }
                .checklist li { font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; }
                .checkbox { width: 25px; height: 25px; border: 2px solid #333; border-radius: 5px; margin-left: 15px; }
            </style>
            </head><body>
                <div class="print-container">
                    <h1>دستور تولید</h1>
                    <div class="batch-code">${batch.code}</div>
                    <div class="info-grid">
                        <span><strong>تاریخ صدور:</strong> ${new Date(batch.creationDate).toLocaleDateString('fa-IR')}</span>
                        <span><strong>تاریخ تحویل:</strong> ${batch.deliveryDate}</span>
                    </div>
                    <div class="main-content">
                        <div>
                           <h4>لیست آیتم‌ها</h4>
                           ${itemsContent}
                        </div>
                        ${checklistContent}
                    </div>
                </div>
            </body></html>`);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); }, 500);
    };

    elements.batchTrackingTableContainer.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            const batchCode = e.target.dataset.batchCode;
            const stage = e.target.dataset.stage;
            const batch = appState.productionBatches[batchCode];
            if (batch) {
                batch.stages[stage] = e.target.checked;
                // Check if all stages are completed
                const allStagesChecked = Object.keys(PRODUCTION_STAGES).every(s => batch.stages[s]);
                if (allStagesChecked && batch.status !== 'completed') {
                    // This logic is now handled by the complete button
                }
                saveState();
                renderTrackingView(true); // Re-render keeping details open
            }
        }
    });

    elements.clearTrackingFiltersBtn.addEventListener('click', () => {
        elements.trackingSearchInput.value = '';
        elements.trackingDateFilter.value = '';
        elements.trackingGroupFilter.value = '';
        elements.trackingStatusFilter.value = '';
        applyTrackingFilters();
    });

    elements.exportTrackingBtn.addEventListener('click', () => {
        const dataToExport = currentFilteredBatches.map(batch => {
             const totalQuantity = batch.logIds.reduce((sum, id) => {
                const log = appState.productionLog.find(l => l.logId === id);
                return sum + (log ? log.quantity : 0);
            }, 0);
             return {
                'کد بچ': batch.code,
                'گروه محصول': batch.productGroup,
                'تاریخ ایجاد': new Date(batch.creationDate).toLocaleString('fa-IR'),
                'تاریخ تحویل': batch.deliveryDate,
                'تعداد کل': totalQuantity,
                'وضعیت': batch.status
            };
        });
        if(dataToExport.length > 0) {
            exportToExcel(dataToExport, 'Tracking_Report.xlsx');
        }
    });

});
</script>
</body>
</html>
