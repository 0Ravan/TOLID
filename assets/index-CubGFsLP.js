import{initializeApp as Et}from"https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";import{getFirestore as vt,doc as Bt,onSnapshot as $t,setDoc as kt}from"https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";import{getAuth as Lt,signOut as St,onAuthStateChanged as Ct,signInWithEmailAndPassword as Tt,createUserWithEmailAndPassword as Ft}from"https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";(function(){const x=document.createElement("link").relList;if(x&&x.supports&&x.supports("modulepreload"))return;for(const E of document.querySelectorAll('link[rel="modulepreload"]'))O(E);new MutationObserver(E=>{for(const v of E)if(v.type==="childList")for(const M of v.addedNodes)M.tagName==="LINK"&&M.rel==="modulepreload"&&O(M)}).observe(document,{childList:!0,subtree:!0});function K(E){const v={};return E.integrity&&(v.integrity=E.integrity),E.referrerPolicy&&(v.referrerPolicy=E.referrerPolicy),E.crossOrigin==="use-credentials"?v.credentials="include":E.crossOrigin==="anonymous"?v.credentials="omit":v.credentials="same-origin",v}function O(E){if(E.ep)return;E.ep=!0;const v=K(E);fetch(E.href,v)}})();const wt={apiKey:"AIzaSyDip8Z7tEGQh45-DUfuYpZQobK3AAGBW4o",authDomain:"my-production-dashboard.firebaseapp.com",projectId:"my-production-dashboard",storageBucket:"my-production-dashboard.firebasestorage.app",messagingSenderId:"626829274209",appId:"1:626829274209:web:cd6b1ccc3b63df29b9ce20"},ct=Et(wt),dt=vt(ct),xt=Lt(ct),Mt=Bt(dt,"dashboardData","mainState");window.firebaseServices={db:dt,auth:xt,dbDocRef:Mt,setDoc:kt,onSnapshot:$t,createUserWithEmailAndPassword:Ft,signInWithEmailAndPassword:Tt,onAuthStateChanged:Ct,signOut:St};document.addEventListener("DOMContentLoaded",()=>{const{auth:w,dbDocRef:x,setDoc:K,onSnapshot:O,createUserWithEmailAndPassword:E,signInWithEmailAndPassword:v,onAuthStateChanged:M,signOut:ut}=window.firebaseServices,o={authContainer:document.getElementById("auth-container"),appContainer:document.getElementById("app-container"),loginForm:document.getElementById("login-form"),signupForm:document.getElementById("signup-form"),authToggle:document.getElementById("auth-toggle"),authTitle:document.getElementById("authTitle"),loginBtn:document.getElementById("loginBtn"),signupBtn:document.getElementById("signupBtn"),logoutBtn:document.getElementById("logoutBtn"),userEmail:document.getElementById("userEmail"),dashboardView:document.getElementById("dashboardView"),processingView:document.getElementById("processingView"),manualProductionView:document.getElementById("manualProductionView"),reportView:document.getElementById("reportView"),printingView:document.getElementById("printingView"),trackingView:document.getElementById("trackingView"),inventoryView:document.getElementById("inventoryView"),materialsView:document.getElementById("materialsView"),excelFile:document.getElementById("excelFile"),fileList:document.getElementById("fileList"),backToDashboard:document.getElementById("backToDashboard"),processingFileName:document.getElementById("processingFileName"),groupFilter:document.getElementById("groupFilter"),colorFilter:document.getElementById("colorFilter"),sizeFilter:document.getElementById("sizeFilter"),processingStatusFilter:document.getElementById("processingStatusFilter"),tasksTableContainer:document.getElementById("tasksTableContainer"),summaryCards:document.getElementById("summaryCards"),createProductionOrderBtn:document.getElementById("createProductionOrderBtn"),showDashboardBtn:document.getElementById("showDashboardBtn"),showReportBtn:document.getElementById("showReportBtn"),showManualProductionBtn:document.getElementById("showManualProductionBtn"),showPrintingBtn:document.getElementById("showPrintingBtn"),showTrackingBtn:document.getElementById("showTrackingBtn"),showInventoryBtn:document.getElementById("showInventoryBtn"),showMaterialsBtn:document.getElementById("showMaterialsBtn"),reportFileFilter:document.getElementById("reportFileFilter"),reportStatusFilter:document.getElementById("reportStatusFilter"),reportBulkUpdateBtn:document.getElementById("reportBulkUpdateBtn"),reportToStatus:document.getElementById("reportToStatus"),reportSummaryCards:document.getElementById("reportSummaryCards"),reportTableContainer:document.getElementById("reportTableContainer"),reportGroupFilter:document.getElementById("reportGroupFilter"),reportColorFilter:document.getElementById("reportColorFilter"),reportSizeFilter:document.getElementById("reportSizeFilter"),reportSkuSearch:document.getElementById("reportSkuSearch"),reportBatchSearch:document.getElementById("reportBatchSearch"),reportBatchFilter:document.getElementById("reportBatchFilter"),assignBatchCodeBtn:document.getElementById("assignBatchCodeBtn"),sendToPrintingBtn:document.getElementById("sendToPrintingBtn"),exportReportBtn:document.getElementById("exportReportBtn"),printingFileFilter:document.getElementById("printingFileFilter"),printingGroupFilter:document.getElementById("printingGroupFilter"),printingColorFilter:document.getElementById("printingColorFilter"),printingSizeFilter:document.getElementById("printingSizeFilter"),clearPrintingFiltersBtn:document.getElementById("clearPrintingFiltersBtn"),printingBulkUpdateBtn:document.getElementById("printingBulkUpdateBtn"),exportPrintingBtn:document.getElementById("exportPrintingBtn"),printPrintingBtn:document.getElementById("printPrintingBtn"),printingSummaryCards:document.getElementById("printingSummaryCards"),printingTableContainer:document.getElementById("printingTableContainer"),inventoryExcelFile:document.getElementById("inventoryExcelFile"),inventoryTableContainer:document.getElementById("inventoryTableContainer"),materialsExcelFile:document.getElementById("materialsExcelFile"),materialName:document.getElementById("materialName"),materialColor:document.getElementById("materialColor"),materialStock:document.getElementById("materialStock"),materialUnit:document.getElementById("materialUnit"),addMaterialBtn:document.getElementById("addMaterialBtn"),materialsTableContainer:document.getElementById("materialsTableContainer"),bomGroupSelect:document.getElementById("bomGroupSelect"),bomMaterialSelect:document.getElementById("bomMaterialSelect"),bomMaterialColorSelect:document.getElementById("bomMaterialColorSelect"),bomConsumptionInput:document.getElementById("bomConsumptionInput"),addBomBtn:document.getElementById("addBomBtn"),bomTableContainer:document.getElementById("bomTableContainer"),manualForm:document.getElementById("manualForm"),addItemToManualListBtn:document.getElementById("addItemToManualListBtn"),manualItemsTableContainer:document.getElementById("manualItemsTableContainer"),saveManualOrderBtn:document.getElementById("saveManualOrderBtn"),clearManualOrderBtn:document.getElementById("clearManualOrderBtn"),batchTrackingTableContainer:document.getElementById("batchTrackingTableContainer"),trackingSearchInput:document.getElementById("trackingSearchInput"),trackingDateFilter:document.getElementById("trackingDateFilter"),trackingGroupFilter:document.getElementById("trackingGroupFilter"),trackingStatusFilter:document.getElementById("trackingStatusFilter"),exportTrackingBtn:document.getElementById("exportTrackingBtn"),importFile:document.getElementById("importFile"),importDataBtn:document.getElementById("importDataBtn"),exportDataBtn:document.getElementById("exportDataBtn"),confirmationModal:document.getElementById("confirmationModal"),modalTitle:document.getElementById("modalTitle"),modalMessage:document.getElementById("modalMessage"),modalConfirmBtn:document.getElementById("modalConfirmBtn"),modalCancelBtn:document.getElementById("modalCancelBtn"),assignBatchModal:document.getElementById("assignBatchModal"),assignBatchModalTitle:document.getElementById("assignBatchModalTitle"),multiBatchAssignmentContainer:document.getElementById("multiBatchAssignmentContainer"),singleBatchAssignmentContainer:document.getElementById("singleBatchAssignmentContainer"),batchAssignmentList:document.getElementById("batchAssignmentList"),batchCodeInput:document.getElementById("batchCodeInput"),batchDeliveryYear:document.getElementById("batchDeliveryYear"),batchDeliveryMonth:document.getElementById("batchDeliveryMonth"),batchDeliveryDay:document.getElementById("batchDeliveryDay"),batchConfirmBtn:document.getElementById("batchConfirmBtn"),batchCancelBtn:document.getElementById("batchCancelBtn"),editQuantityModal:document.getElementById("editQuantityModal"),editQuantityList:document.getElementById("editQuantityList"),inventoryWarningContainer:document.getElementById("inventoryWarningContainer"),finishedGoodsWarning:document.getElementById("finishedGoodsWarning"),rawMaterialsWarning:document.getElementById("rawMaterialsWarning"),quantityConfirmBtn:document.getElementById("quantityConfirmBtn"),quantityCancelBtn:document.getElementById("quantityCancelBtn"),clearProcessingFiltersBtn:document.getElementById("clearProcessingFiltersBtn"),clearReportFiltersBtn:document.getElementById("clearReportFiltersBtn"),clearTrackingFiltersBtn:document.getElementById("clearTrackingFiltersBtn")},H={files:{},productionLog:[],productionBatches:{},inventory:{},materials:{},bom:{},fileCounter:0,batchCounterA:1,batchMonthA:"",batchCounterK:1,batchMonthK:"",activeFileId:null};let s={...H},_=!0,R=new Set;const p={READY:"آماده تولید",IN_PROGRESS:"درحال انجام",IN_PRODUCTION:"در حال تولید",PRINTING:"در دست چاپ",PRINTED:"چاپ شده",DONE:"انجام شده",CANCELLED:"ابطال"},P={preparationPattern:"آماده سازی و الگو",cutting:"برش",sewing:"دوخت",ironing:"اتو",qualityControl:"کنترل کیفی",outsourcing:"برون سپاری",stoneWashing:"سنگ شوری",packaging:"بسته بندی"};let $=[],G=[],S={logIds:[],groups:{}};async function f(){if(window.firebaseServices&&window.firebaseServices.setDoc)try{const t=JSON.parse(JSON.stringify(s));await window.firebaseServices.setDoc(window.firebaseServices.dbDocRef,t)}catch(t){console.error("Error during state serialization or saving to Firebase:",t),console.log("State object that failed to save:",s),g("خطا در ذخیره سازی اطلاعات. داده نامعتبر شناسایی شد.","error")}}function J(t){if(s={...H,...t},_)T(),B("dashboardView"),_=!1;else{const n=document.querySelector(".page-view:not(.hidden)");if(!n){T(),B("dashboardView");return}switch(n.id){case"dashboardView":T();break;case"processingView":s.activeFileId&&s.files[s.activeFileId]?at():(B("dashboardView"),T());break;case"reportView":rt();break;case"printingView":it();break;case"trackingView":st(!0);break;case"inventoryView":ot();break;case"materialsView":nt();break}}}M(w,t=>{t?(_=!0,o.appContainer.style.display="block",o.authContainer.style.display="none",o.userEmail.textContent=t.email,O(x,n=>{n.metadata.hasPendingWrites||(n.exists()?J(n.data()):(J(H),f()))})):(o.appContainer.style.display="none",o.authContainer.style.display="block")}),o.authToggle.addEventListener("click",()=>{const t=o.loginForm.classList.contains("hidden");o.loginForm.classList.toggle("hidden"),o.signupForm.classList.toggle("hidden"),o.authTitle.textContent=t?"ورود به داشبورد":"ایجاد حساب کاربری",o.authToggle.textContent=t?"حساب کاربری ندارید؟ ثبت نام کنید":"حساب کاربری دارید؟ وارد شوید"}),o.signupBtn.addEventListener("click",async()=>{const t=document.getElementById("signupEmail").value,n=document.getElementById("signupPassword").value;try{await E(w,t,n),g("ثبت نام با موفقیت انجام شد.","success")}catch(e){g(`خطا در ثبت نام: ${e.message}`,"error")}}),o.loginBtn.addEventListener("click",async()=>{const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value;try{await v(w,t,n)}catch(e){g(`خطا در ورود: ${e.message}`,"error")}}),o.logoutBtn.addEventListener("click",async()=>{try{await ut(w)}catch(t){g(`خطا در خروج: ${t.message}`,"error")}});let A=null;const k=(t,n,e)=>{o.modalTitle.textContent=t,o.modalMessage.innerHTML=n,A=e,X(o.confirmationModal)},Z=()=>{D(o.confirmationModal),A=null};o.modalConfirmBtn.addEventListener("click",()=>{A&&A(),Z()}),o.modalCancelBtn.addEventListener("click",Z);const X=t=>t.classList.remove("hidden"),D=t=>t.classList.add("hidden");o.batchCancelBtn.addEventListener("click",()=>D(o.assignBatchModal)),o.quantityCancelBtn.addEventListener("click",()=>D(o.editQuantityModal));const g=(t,n="success")=>{const e=document.createElement("div");e.textContent=t,e.style.cssText=`position: fixed; top: -100px; left: 50%; transform: translateX(-50%); color: white; padding: 15px 25px; border-radius: 8px; z-index: 3000; opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); box-shadow: 0 4px 15px rgba(0,0,0,0.2); background-color: ${n==="success"?"var(--success-color)":"var(--danger-color)"};`,document.body.appendChild(e),setTimeout(()=>{e.style.top="30px",e.style.opacity="1"},10),setTimeout(()=>{e.style.opacity="0",e.style.top="-100px",setTimeout(()=>e.remove(),500)},4e3)},tt=(t,n)=>{const e=XLSX.utils.json_to_sheet(t),r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,e,"Sheet1"),XLSX.writeFile(r,n)},et=(t="")=>{let n=t,e="نامشخص",r="تک سایز",i="سایر";const l=["S","M","L","XL","2XL","3XL","XXL","XS"],a=new RegExp(`\\b(${l.join("|")})\\b`,"i"),c={هودی:"هودی",تیشرت:"تیشرت",بامبر:"بامبر",دورس:"دورس",شلوار:"شلوار",سویشرت:"سویشرت"};for(const u in c)if(t.includes(u)){i=c[u];break}const d=n.split(" - ");if(d.length>1){n=d[0].trim();const u=d[1].split(",").map(m=>m.trim());let h=!1;for(const m of u){const b=m.match(a);b&&!h?(r=b[0].toUpperCase(),h=!0):e=m}}return{productName:n,color:e,size:r,productGroup:i}},B=t=>{["dashboardView","processingView","reportView","manualProductionView","printingView","trackingView","inventoryView","materialsView"].forEach(n=>o[n].classList.add("hidden")),o[t].classList.remove("hidden")};o.showDashboardBtn.addEventListener("click",()=>B("dashboardView")),o.showManualProductionBtn.addEventListener("click",()=>B("manualProductionView")),o.showReportBtn.addEventListener("click",()=>{B("reportView"),rt()}),o.showPrintingBtn.addEventListener("click",()=>{B("printingView"),it()}),o.showTrackingBtn.addEventListener("click",()=>{B("trackingView"),st()}),o.showInventoryBtn.addEventListener("click",()=>{B("inventoryView"),ot()}),o.showMaterialsBtn.addEventListener("click",()=>{B("materialsView"),nt()}),o.backToDashboard.addEventListener("click",()=>{s.activeFileId=null,B("dashboardView")}),o.exportDataBtn.addEventListener("click",()=>{try{const t={...s},n=JSON.stringify(t,null,2),e=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(e),i=document.createElement("a");i.href=r,i.download=`production-dashboard-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),g("نسخه پشتیبان با موفقیت ایجاد شد.")}catch(t){g(`خطا در ایجاد نسخه پشتیبان: ${t.message}`,"error")}}),o.importDataBtn.addEventListener("click",()=>o.importFile.click()),o.importFile.addEventListener("change",t=>{const n=t.target.files[0];if(!n)return;const e=new FileReader;e.onload=r=>{try{const i=JSON.parse(r.target.result);if(!i.files||!i.productionLog)throw new Error("فایل پشتیبان معتبر نیست.");k("تایید بازیابی اطلاعات","آیا مطمئن هستید؟ تمام اطلاعات فعلی با اطلاعات فایل پشتیبان جایگزین خواهد شد. این عمل غیرقابل بازگشت است.",()=>{s=i,f(),g("اطلاعات با موفقیت بازیابی شد.")})}catch(i){g(`خطا در بازیابی اطلاعات: ${i.message}`,"error")}finally{t.target.value=""}},e.readAsText(n)});const T=()=>{if(o.fileList.innerHTML="",Object.keys(s.files).length===0){o.fileList.innerHTML="<p>هیچ فایلی برای نمایش وجود ندارد. لطفاً یک فایل جدید بارگذاری کنید.</p>";return}for(const t in s.files){const n=s.files[t],e=document.createElement("div");e.className="file-list-item",e.innerHTML=`<span><strong>(${n.shortId}) ${n.name}</strong></span><div><button class="btn-primary" data-id="${t}">مشاهده</button><button class="btn-danger" data-id="${t}">حذف</button></div>`,o.fileList.appendChild(e)}};o.fileList.addEventListener("click",t=>{const n=t.target.dataset.id;if(n)if(t.target.textContent==="حذف"){const e=s.files[n];if(!e){g("این فایل دیگر وجود ندارد. لیست به‌روزرسانی شد.","error"),T();return}k("تایید حذف فایل",`آیا از حذف فایل <strong>"${e.name}"</strong> و تمام سوابق آن اطمینان دارید؟`,()=>{delete s.files[n],s.productionLog=s.productionLog.filter(r=>r.sourceFileId!==n),Object.keys(s.productionBatches).forEach(r=>{s.productionBatches[r].sourceFileId===n&&delete s.productionBatches[r]}),f(),g("فایل حذف شد.")})}else t.target.textContent==="مشاهده"&&(s.activeFileId=n,B("processingView"),at())}),o.excelFile.addEventListener("change",t=>{for(const n of t.target.files){const e=new FileReader;e.onload=r=>{try{const i=new Uint8Array(r.target.result),l=XLSX.read(i,{type:"array"}),a=XLSX.utils.sheet_to_json(l.Sheets[l.SheetNames[0]]);if(a.length===0)throw new Error("فایل خالی است.");s.fileCounter++;const c=`F${s.fileCounter}`,d=`file_${Date.now()}`,u={};a.forEach(h=>{const{SKU:m}=h;if(!m)return;const b=parseInt(h["تعداد (- استرداد)"],10)||0;if(b<=0)return;const{productName:y,color:I,size:L,productGroup:C}=et(h["نام آیتم"]),N=`${m}-${y}-${I}-${L}`;u[N]||(u[N]={uniqueId:`${c}-${m}-${y.replace(/\s/g,"")}-${I.replace(/\s/g,"")}-${L}`,sku:m,productName:y,color:I,size:L,productGroup:C,quantity:0,status:p.READY}),u[N].quantity+=b}),s.files[d]={id:d,shortId:c,name:n.name,uploadDate:new Date().toLocaleDateString("fa-IR"),tasks:Object.values(u)},f(),g(`فایل "${n.name}" بارگذاری شد.`)}catch(i){g(`خطا در پردازش: ${i.message}`,"error")}},e.readAsArrayBuffer(n)}t.target.value=""});const nt=()=>{const t=Object.keys(s.materials);let n="<table><thead><tr><th>ماده اولیه</th><th>رنگ</th><th>موجودی</th><th>واحد</th><th>حذف</th></tr></thead><tbody>";t.length>0?t.forEach(a=>{Object.keys(s.materials[a]).forEach(c=>{const d=s.materials[a][c];n+=`<tr><td>${a}</td><td>${c}</td><td>${d.stock}</td><td>${d.unit}</td><td><button class="btn-danger btn-sm" data-delete-material-name="${a}" data-delete-material-color="${c}">X</button></td></tr>`})}):n+='<tr><td colspan="5">هیچ ماده اولیه‌ای تعریف نشده است.</td></tr>',o.materialsTableContainer.innerHTML=n+"</tbody></table>";let e="<table><thead><tr><th>گروه محصول</th><th>ماده اولیه</th><th>رنگ</th><th>میزان مصرف</th><th>حذف</th></tr></thead><tbody>";const r=Object.keys(s.bom);r.length>0?r.forEach(a=>{Object.keys(s.bom[a]).forEach(c=>{Object.keys(s.bom[a][c]).forEach(d=>{e+=`<tr><td>${a}</td><td>${c}</td><td>${d}</td><td>${s.bom[a][c][d]}</td><td><button class="btn-danger btn-sm" data-delete-bom-group="${a}" data-delete-bom-material="${c}" data-delete-bom-color="${d}">X</button></td></tr>`})})}):e+='<tr><td colspan="5">هیچ استاندارد مصرفی تعریف نشده است.</td></tr>',o.bomTableContainer.innerHTML=e+"</tbody></table>";const i=["هودی","تیشرت","بامبر","دورس","شلوار","سویشرت","سایر"],l=new Set(i);Object.values(s.files).forEach(a=>a.tasks.forEach(c=>l.add(c.productGroup))),o.bomGroupSelect.innerHTML='<option value="">-- گروه محصول --</option>'+[...l].sort().map(a=>`<option>${a}</option>`).join(""),o.bomMaterialSelect.innerHTML='<option value="">-- ماده اولیه --</option>'+t.sort().map(a=>`<option>${a}</option>`).join(""),o.bomMaterialColorSelect.innerHTML='<option value="">-- رنگ ماده --</option>'};o.bomMaterialSelect.addEventListener("change",t=>{const n=t.target.value,e=n&&s.materials[n]?Object.keys(s.materials[n]):[];o.bomMaterialColorSelect.innerHTML='<option value="">-- رنگ ماده --</option>'+e.sort().map(r=>`<option>${r}</option>`).join("")}),o.addMaterialBtn.addEventListener("click",()=>{const t=o.materialName.value.trim(),n=o.materialColor.value.trim(),e=parseInt(o.materialStock.value,10),r=o.materialUnit.value.trim();if(!t||!n||isNaN(e)||e<0||!r){g("نام، رنگ، موجودی و واحد معتبر وارد کنید.","error");return}s.materials[t]||(s.materials[t]={}),s.materials[t][n]?s.materials[t][n].stock+=e:s.materials[t][n]={stock:e,unit:r},f(),o.materialName.value="",o.materialColor.value="",o.materialStock.value="",o.materialUnit.value=""}),o.materialsTableContainer.addEventListener("click",t=>{const n=t.target.dataset.deleteMaterialName,e=t.target.dataset.deleteMaterialColor;n&&e&&k("تایید حذف ماده اولیه",`آیا از حذف ماده اولیه '${n} - ${e}' و تمام استانداردهای مصرف آن اطمینان دارید؟`,()=>{delete s.materials[n][e],Object.keys(s.materials[n]).length===0&&delete s.materials[n],Object.keys(s.bom).forEach(r=>{s.bom[r][n]&&s.bom[r][n][e]&&(delete s.bom[r][n][e],Object.keys(s.bom[r][n]).length===0&&delete s.bom[r][n])}),f(),g(`ماده اولیه '${n} - ${e}' حذف شد.`)})}),o.addBomBtn.addEventListener("click",()=>{const t=o.bomGroupSelect.value,n=o.bomMaterialSelect.value,e=o.bomMaterialColorSelect.value,r=parseFloat(o.bomConsumptionInput.value);if(!t||!n||!e||isNaN(r)||r<=0){g("لطفا تمام فیلدهای استاندارد مصرف را به درستی پر کنید.","error");return}s.bom[t]||(s.bom[t]={}),s.bom[t][n]||(s.bom[t][n]={}),s.bom[t][n][e]=r,f(),o.bomConsumptionInput.value=""}),o.bomTableContainer.addEventListener("click",t=>{const n=t.target.dataset.deleteBomGroup,e=t.target.dataset.deleteBomMaterial,r=t.target.dataset.deleteBomColor;n&&e&&r&&k("تایید حذف استاندارد","آیا از حذف این استاندارد مصرف اطمینان دارید؟",()=>{delete s.bom[n][e][r],Object.keys(s.bom[n][e]).length===0&&delete s.bom[n][e],Object.keys(s.bom[n]).length===0&&delete s.bom[n],f()})}),o.materialsExcelFile.addEventListener("change",t=>{const n=t.target.files[0];if(!n)return;const e=new FileReader;e.onload=r=>{try{const i=new Uint8Array(r.target.result),l=XLSX.read(i,{type:"array"}),a=XLSX.utils.sheet_to_json(l.Sheets[l.SheetNames[0]]);if(a.length===0)throw new Error("فایل خالی است.");let c=0;a.forEach(d=>{const u=d["نام مواد اولیه"],h=d.رنگ||"نامشخص",m=parseFloat(d.مقدار),b=d["واحد سنجش"];if(u&&!isNaN(m)&&b){const y=u.trim(),I=h.trim();s.materials[y]||(s.materials[y]={}),s.materials[y][I]?s.materials[y][I].stock+=m:s.materials[y][I]={stock:m,unit:b.trim()},c++}}),c>0?(f(),g(`${c} ماده اولیه با موفقیت اضافه/به‌روزرسانی شد.`)):g('هیچ ردیف معتبری در فایل اکسل یافت نشد. ستون‌ها باید "نام مواد اولیه"، "رنگ"، "مقدار" و "واحد سنجش" باشند.',"error")}catch(i){g(`خطا در پردازش فایل: ${i.message}`,"error")}},e.readAsArrayBuffer(n),t.target.value=""});const ot=()=>{o.inventoryTableContainer.innerHTML="";const t=Object.keys(s.inventory);if(t.length===0){o.inventoryTableContainer.innerHTML="<p>موجودی انبار خالی است. لطفا فایل موجودی را بارگذاری کنید.</p>";return}let n="<h3>موجودی دقیق محصولات</h3><table><thead><tr><th>گروه محصول</th><th>رنگ</th><th>سایز</th><th>تعداد موجودی</th></tr></thead><tbody>",e=!1;for(const r of t.sort())for(const i of Object.keys(s.inventory[r]).sort())for(const l of Object.keys(s.inventory[r][i]).sort()){const a=s.inventory[r][i][l];a>0&&(n+=`<tr><td>${r}</td><td>${i}</td><td>${l}</td><td><strong>${a}</strong></td></tr>`,e=!0)}if(!e){o.inventoryTableContainer.innerHTML="<p>موجودی انبار خالی است.</p>";return}n+="</tbody></table>",o.inventoryTableContainer.innerHTML=n};o.inventoryExcelFile.addEventListener("change",t=>{const n=t.target.files[0];if(!n)return;const e=new FileReader;e.onload=r=>{try{const i=new Uint8Array(r.target.result),l=XLSX.read(i,{type:"array"}),a=XLSX.utils.sheet_to_json(l.Sheets[l.SheetNames[0]]);if(a.length===0)throw new Error("فایل موجودی خالی است.");let c=0;a.forEach(d=>{const u=parseInt(d["تعداد (- استرداد)"],10)||0,h=d["نام آیتم"];if(u!==0&&h){const{productGroup:m,color:b,size:y}=et(h);s.inventory[m]||(s.inventory[m]={}),s.inventory[m][b]||(s.inventory[m][b]={}),s.inventory[m][b][y]=(s.inventory[m][b][y]||0)+u,c++}}),c>0&&(f(),g("فایل موجودی با موفقیت بارگذاری و مقادیر به موجودی فعلی اضافه/کسر شد."))}catch(i){g(`خطا در پردازش فایل موجودی: ${i.message}`,"error")}},e.readAsArrayBuffer(n),t.target.value=""});const q=()=>{if($.length===0){o.manualItemsTableContainer.innerHTML="<p>هنوز آیتمی اضافه نشده است.</p>";return}let t="<table><thead><tr><th>محصول</th><th>کد طرح</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>حذف</th></tr></thead><tbody>";$.forEach((n,e)=>{t+=`<tr><td>${n.productName}</td><td>${n.sku}</td><td>${n.color}</td><td>${n.size}</td><td>${n.quantity}</td><td><button class="btn-danger" data-index="${e}">X</button></td></tr>`}),o.manualItemsTableContainer.innerHTML=t+"</tbody></table>"};o.addItemToManualListBtn.addEventListener("click",()=>{const t={productName:document.getElementById("manualProductName").value.trim(),sku:document.getElementById("manualSku").value.trim(),color:document.getElementById("manualColor").value.trim(),size:document.getElementById("manualSize").value,quantity:parseInt(document.getElementById("manualQuantity").value,10),productGroup:document.getElementById("manualGroup").value};if(!t.productName||!t.sku||!t.color||!t.size||!t.quantity||!t.productGroup){g("لطفا تمام فیلدها را پر کنید.","error");return}$.push({...t,status:p.IN_PROGRESS}),q(),o.manualForm.reset()}),o.manualItemsTableContainer.addEventListener("click",t=>{t.target.classList.contains("btn-danger")&&($.splice(parseInt(t.target.dataset.index,10),1),q())}),o.saveManualOrderBtn.addEventListener("click",()=>{if($.length===0){g("هیچ آیتمی برای ذخیره وجود ندارد.","error");return}const t=`MANUAL-${Date.now()}`,n=new Date().toLocaleString("fa-IR");$.forEach(e=>{s.productionLog.push({...e,logId:`${t}-${e.sku}-${e.size}`,orderId:t,orderDate:n,sourceFileId:"manual",sourceFileShortId:"دستی"})}),f(),g(`${$.length} آیتم دستی ذخیره شد.`),$=[],q()}),o.clearManualOrderBtn.addEventListener("click",()=>{$.length>0&&k("پاک کردن لیست","آیا از پاک کردن لیست فعلی اطمینان دارید؟",()=>{$=[],q(),g("لیست پاک شد.")})});const at=()=>{const t=s.files[s.activeFileId];if(!t){g("فایل انتخاب شده یافت نشد. بازگشت به داشبورد...","error"),B("dashboardView"),T();return}o.processingFileName.textContent=`پردازش فایل: (${t.shortId}) ${t.name}`;const n=t.tasks,e=[...new Set(n.map(l=>l.productGroup))],r=[...new Set(n.map(l=>l.color))],i=[...new Set(n.map(l=>l.size))];o.groupFilter.innerHTML='<option value="">همه</option>'+e.map(l=>`<option>${l}</option>`).join(""),o.colorFilter.innerHTML='<option value="">همه</option>'+r.map(l=>`<option>${l}</option>`).join(""),o.sizeFilter.innerHTML='<option value="">همه</option>'+i.map(l=>`<option>${l}</option>`).join(""),j()},j=()=>{if(!s.activeFileId)return;const t=s.files[s.activeFileId],n=o.groupFilter.value,e=o.colorFilter.value,r=o.sizeFilter.value,i=o.processingStatusFilter.value,l=t.tasks.filter(a=>(!n||a.productGroup===n)&&(!e||a.color===e)&&(!r||a.size===r)&&(!i||a.status===i));l.sort((a,c)=>String(a.sku).localeCompare(String(c.sku),void 0,{numeric:!0})),mt(l),pt(l,o.summaryCards,"فیلتر")};[o.groupFilter,o.colorFilter,o.sizeFilter,o.processingStatusFilter].forEach(t=>t.addEventListener("change",j));const pt=(t,n,e)=>{const r={total:0,[p.READY]:0,[p.IN_PROGRESS]:0,[p.PRINTING]:0,[p.DONE]:0,[p.CANCELLED]:0};t.forEach(i=>{r.total+=i.quantity,r[i.status]!==void 0&&(r[i.status]+=i.quantity)}),n.innerHTML=`
            <div class="card card-total"><h4>کل آیتم‌های ${e}</h4><div class="count">${r.total}</div></div>
            <div class="card card-ready"><h4>${p.READY}</h4><div class="count">${r[p.READY]}</div></div>
            <div class="card card-inprogress"><h4>${p.IN_PROGRESS}</h4><div class="count">${r[p.IN_PROGRESS]}</div></div>
            <div class="card card-done"><h4>${p.DONE}</h4><div class="count">${r[p.DONE]}</div></div>
        `},mt=t=>{let n='<table><thead><tr><th><input type="checkbox" id="selectAllTasks"></th><th>کد طرح</th><th>محصول</th><th>رنگ</th><th>سایز</th><th>تعداد</th><th>گروه</th><th>وضعیت</th></tr></thead><tbody>';t.forEach(e=>{n+=`<tr>
                <td><input type="checkbox" class="task-checkbox" data-id="${e.uniqueId}"></td>
                <td>${e.sku}</td><td>${e.productName}</td><td>${e.color}</td><td>${e.size}</td>
                <td>${e.quantity}</td><td>${e.productGroup}</td><td>${e.status}</td></tr>`}),o.tasksTableContainer.innerHTML=n+"</tbody></table>"};o.tasksTableContainer.addEventListener("change",t=>{t.target.id==="selectAllTasks"&&document.querySelectorAll(".task-checkbox").forEach(n=>n.checked=t.target.checked)}),o.createProductionOrderBtn.addEventListener("click",()=>{const t=[...document.querySelectorAll(".task-checkbox:checked")].map(i=>i.dataset.id);if(t.length===0){g("هیچ آیتمی برای صدور دستور انتخاب نشده است.","error");return}const n=s.files[s.activeFileId],e=t.map(i=>n.tasks.find(l=>l.uniqueId===i)).filter(i=>i&&i.status===p.READY);if(e.length===0){g('فقط آیتم‌های با وضعیت "آماده تولید" قابل ارسال هستند.',"error");return}let r="";e.forEach(i=>{r+=`<div class="modal-form-group">
                <label>${i.productName} - ${i.color} - ${i.size} (کد: ${i.sku})</label>
                <input type="number" data-task-id="${i.uniqueId}" value="${i.quantity}" min="0" max="${i.quantity}" class="quantity-input">
            </div>`}),o.editQuantityList.innerHTML=r,ht(e),X(o.editQuantityModal)});const ht=t=>{const n={},e={};t.forEach(a=>{const c=`${a.productGroup}||${a.color}||${a.size}`;n[c]=(n[c]||0)+a.quantity});let r="<h5>موجودی محصول آماده</h5>",i=!1;Object.keys(n).forEach(a=>{var y,I;const[c,d,u]=a.split("||"),h=n[a],m=((I=(y=s.inventory[c])==null?void 0:y[d])==null?void 0:I[u])||0,b=h-m;b>0?(r+=`<p><strong>${c} - ${d} - ${u}:</strong> نیاز: ${h} | موجودی: ${m} | <span class="low-inventory">کسری: ${b}</span></p>`,i=!0):r+=`<p><strong>${c} - ${d} - ${u}:</strong> نیاز: ${h} | موجودی: ${m} | <span style="color: var(--success-color);">تامین</span></p>`}),o.finishedGoodsWarning.innerHTML=i?r:"<h5>موجودی محصول آماده</h5><p>تمام محصولات مورد نیاز در انبار موجود است.</p>",Object.keys(n).forEach(a=>{var y,I;const[c,d,u]=a.split("||"),h=n[a],m=((I=(y=s.inventory[c])==null?void 0:y[d])==null?void 0:I[u])||0,b=Math.max(0,h-m);b>0&&s.bom[c]&&Object.keys(s.bom[c]).forEach(L=>{Object.keys(s.bom[c][L]).forEach(C=>{const N=s.bom[c][L][C],lt=`${L}||${C}`;e[lt]=(e[lt]||0)+b*N})})});let l="<h5>موجودی مواد اولیه</h5>";Object.keys(e).length===0?l+="<p>نیازی به مواد اولیه جدید نیست یا استاندارد مصرف تعریف نشده است.</p>":Object.keys(e).forEach(a=>{var y,I,L,C;const[c,d]=a.split("||"),u=e[a],h=((I=(y=s.materials[c])==null?void 0:y[d])==null?void 0:I.stock)||0,m=((C=(L=s.materials[c])==null?void 0:L[d])==null?void 0:C.unit)||"نامشخص",b=u-h;b>0?l+=`<p><strong>${c} - ${d}:</strong> نیاز: ${u.toFixed(2)} ${m} | موجودی: ${h} ${m} | <span class="low-inventory">کسری: ${b.toFixed(2)} ${m}</span></p>`:l+=`<p><strong>${c} - ${d}:</strong> نیاز: ${u.toFixed(2)} ${m} | موجودی: ${h} ${m} | <span style="color: var(--success-color);">تامین</span></p>`}),o.rawMaterialsWarning.innerHTML=l};o.quantityConfirmBtn.addEventListener("click",()=>{const t=s.files[s.activeFileId],n=document.querySelectorAll("#editQuantityList .quantity-input");let e=0;n.forEach(r=>{const i=r.dataset.taskId,l=parseInt(r.value,10);if(isNaN(l)||l<=0)return;const a=t.tasks.findIndex(u=>u.uniqueId===i);if(a===-1)return;const c=t.tasks[a];if(l>c.quantity){g(`تعداد ارسالی برای ${c.productName} بیشتر از موجودی است.`,"error");return}const d={...c,quantity:l,status:p.IN_PROGRESS,logId:`${c.uniqueId}-${Date.now()}`,sourceFileId:s.activeFileId,sourceFileShortId:t.shortId,orderDate:new Date().toLocaleString("fa-IR")};s.productionLog.push(d),e++,l<c.quantity?c.quantity-=l:c.status=p.IN_PROGRESS}),e>0&&(f(),g(`${e} دستور تولید با موفقیت صادر شد.`),D(o.editQuantityModal),j())}),o.clearProcessingFiltersBtn.addEventListener("click",()=>{o.groupFilter.value="",o.colorFilter.value="",o.sizeFilter.value="",o.processingStatusFilter.value="",j()});const rt=()=>{const t=s.productionLog,e=[...new Set(t.map(a=>a.sourceFileId))].map(a=>{if(a==="manual")return{id:"manual",name:"کارمزدی"};const c=s.files[a];return c?{id:c.id,name:`(${c.shortId}) ${c.name}`}:null}).filter(Boolean);o.reportFileFilter.innerHTML='<option value="">همه فایل‌ها</option>'+e.map(a=>`<option value="${a.id}">${a.name}</option>`).join("");const r=[...new Set(t.map(a=>a.productGroup))];o.reportGroupFilter.innerHTML='<option value="">همه گروه‌ها</option>'+r.map(a=>`<option>${a}</option>`).join("");const i=[...new Set(t.map(a=>a.color))];o.reportColorFilter.innerHTML='<option value="">همه رنگ‌ها</option>'+i.map(a=>`<option>${a}</option>`).join("");const l=[...new Set(t.map(a=>a.size))];o.reportSizeFilter.innerHTML='<option value="">همه سایزها</option>'+l.map(a=>`<option>${a}</option>`).join(""),z()},z=()=>{const t=o.reportFileFilter.value,n=o.reportStatusFilter.value,e=o.reportGroupFilter.value,r=o.reportColorFilter.value,i=o.reportSizeFilter.value,l=o.reportSkuSearch.value.trim().toLowerCase(),a=o.reportBatchSearch.value.trim().toLowerCase(),c=o.reportBatchFilter.value,d=s.productionLog.filter(u=>(!t||u.sourceFileId===t)&&(!n||u.status===n)&&(!e||u.productGroup===e)&&(!r||u.color===r)&&(!i||u.size===i)&&(!l||String(u.sku).toLowerCase().includes(l))&&(!a||u.batchCode&&u.batchCode.toLowerCase().includes(a))&&(c===""||c==="assigned"&&u.batchCode||c==="unassigned"&&!u.batchCode));yt(d)};[o.reportFileFilter,o.reportStatusFilter,o.reportGroupFilter,o.reportColorFilter,o.reportSizeFilter,o.reportBatchFilter].forEach(t=>t.addEventListener("change",z)),[o.reportSkuSearch,o.reportBatchSearch].forEach(t=>t.addEventListener("input",z));const gt=t=>{switch(t){case p.READY:return"status-ready";case p.IN_PROGRESS:return"status-inprogress";case p.IN_PRODUCTION:return"status-inproduction";case p.PRINTING:return"status-printing";case p.PRINTED:return"status-printed";case p.DONE:return"status-done";case p.CANCELLED:return"status-cancelled";default:return""}},V=t=>{let n="";switch(t){case p.DONE:n="status-badge-completed";break;case p.IN_PROGRESS:n="status-badge-inprogress";break;case p.IN_PRODUCTION:n="status-badge-tracking";break;case p.CANCELLED:n="status-badge-cancelled";break;case p.PRINTING:n="status-badge-printing";break;case p.PRINTED:n="status-badge-printed";break;case p.READY:n="status-badge-ready";break}return`<span class="status-badge ${n}">${t}</span>`},yt=t=>{t.sort((e,r)=>(r.orderDate||"").localeCompare(e.orderDate||""));let n=`<table><thead><tr>
            <th><input type="checkbox" id="selectAllReport"></th>
            <th>کد بچ</th><th>کد طرح</th><th>محصول</th><th>رنگ</th><th>سایز</th>
            <th>تعداد</th><th>وضعیت</th><th>وضعیت چاپ</th><th>منبع</th><th>عملیات</th>
        </tr></thead><tbody>`;t.length===0?n+='<tr><td colspan="11">هیچ موردی با این فیلترها یافت نشد.</td></tr>':t.forEach(e=>{var u;let r=e.status,i="";(e.status===p.PRINTING||e.status===p.PRINTED)&&(i=e.status,e.batchCode?r=p.IN_PRODUCTION:r=p.IN_PROGRESS);const l=gt(e.status),a=V(r),c=i?V(i):"",d=e.sourceFileId==="manual"?"کارمزدی":((u=s.files[e.sourceFileId])==null?void 0:u.name)||"نامشخص";n+=`<tr class="${l} ${e.batchCode?"has-batch-code":""}">
                    <td><input type="checkbox" class="report-checkbox" data-id="${e.logId}"></td>
                    <td>${e.batchCode||"-"}</td>
                    <td>${e.sku}</td>
                    <td>${e.productName}</td>
                    <td>${e.color}</td>
                    <td>${e.size}</td>
                    <td>${e.quantity}</td>
                    <td>${a}</td>
                    <td>${c}</td>
                    <td>${e.sourceFileShortId} (${d})</td>
                    <td><button class="btn-danger btn-sm" data-delete-log-id="${e.logId}">حذف</button></td>
                </tr>`}),o.reportTableContainer.innerHTML=n+"</tbody></table>"};o.reportTableContainer.addEventListener("click",t=>{if(t.target.dataset.deleteLogId){const n=t.target.dataset.deleteLogId,e=s.productionLog.find(r=>r.logId===n);k("تایید حذف",`آیا از حذف آیتم "${e.productName} - ${e.color}" اطمینان دارید؟`,()=>{s.productionLog=s.productionLog.filter(r=>r.logId!==n),Object.keys(s.productionBatches).forEach(r=>{const i=s.productionBatches[r],l=i.logIds.indexOf(n);l>-1&&i.logIds.splice(l,1)}),f(),g("آیتم حذف شد.")})}}),o.reportTableContainer.addEventListener("change",t=>{t.target.id==="selectAllReport"&&document.querySelectorAll(".report-checkbox").forEach(n=>n.checked=t.target.checked)}),o.reportBulkUpdateBtn.addEventListener("click",()=>{const t=[...document.querySelectorAll(".report-checkbox:checked")].map(r=>r.dataset.id);if(t.length===0){g("هیچ آیتمی انتخاب نشده است.","error");return}const n=o.reportToStatus.value;let e=0;t.forEach(r=>{const i=s.productionLog.find(l=>l.logId===r);if(i)if(n===p.READY)if(i.sourceFileId!=="manual"){const a=s.files[i.sourceFileId].tasks.find(c=>c.uniqueId.startsWith(i.uniqueId.split("-")[0]));a&&(a.status!==p.READY?(a.quantity+=i.quantity,a.status=p.READY):a.quantity+=i.quantity,s.productionLog=s.productionLog.filter(c=>c.logId!==r),e++)}else i.status=n,e++;else i.status=n,e++}),e>0&&(f(),g(`${e} آیتم به‌روزرسانی شد.`))}),o.sendToPrintingBtn.addEventListener("click",()=>{const t=[...document.querySelectorAll(".report-checkbox:checked")].map(e=>e.dataset.id);if(t.length===0){g("هیچ آیتمی انتخاب نشده است.","error");return}let n=0;t.forEach(e=>{const r=s.productionLog.find(i=>i.logId===e);r&&(r.status===p.IN_PROGRESS||r.status===p.IN_PRODUCTION)&&(r.status=p.PRINTING,n++)}),n>0?(f(),g(`${n} آیتم برای چاپ ارسال شد.`)):g("هیچ آیتم واجد شرایطی (وضعیت درحال انجام یا در حال تولید) برای ارسال یافت نشد.","error")}),o.assignBatchCodeBtn.addEventListener("click",()=>{const t=[...document.querySelectorAll(".report-checkbox:checked")].map(l=>l.dataset.id);if(t.length===0){g("هیچ آیتمی برای اختصاص کد بچ انتخاب نشده است.","error");return}const e=t.map(l=>s.productionLog.find(a=>a.logId===l)).filter(Boolean).filter(l=>[p.IN_PROGRESS,p.PRINTING,p.PRINTED,p.IN_PRODUCTION].includes(l.status)&&!l.batchCode);if(e.length===0){g("هیچ آیتم واجد شرایطی (درحال انجام، در دست چاپ، چاپ شده، یا در حال تولید و بدون کد بچ) برای اختصاص کد یافت نشد.","error");return}S.logIds=e.map(l=>l.logId);const r={};e.forEach(l=>{const a=l.productGroup;r[a]||(r[a]=[]),r[a].push(l.logId)}),S.groups=r;const i=Object.keys(r);if(i.length>1){o.singleBatchAssignmentContainer.classList.add("hidden"),o.multiBatchAssignmentContainer.classList.remove("hidden"),o.assignBatchModalTitle.textContent="اختصاص کد بچ گروهی";let l="";i.forEach((a,c)=>{const u=U(a==="هودی"||a==="بامبر"||a==="دورس"?"K":"A",!0);l+=`
                    <div class="batch-group-item">
                        <h4>گروه: ${a}</h4>
                         <div class="modal-form-row">
                            <div class="modal-form-group">
                                <label>کد بچ/سری:</label>
                                <input type="text" data-group-key="${a}" class="multi-batch-code-input" value="${u}" readonly>
                            </div>
                             <div class="modal-form-group">
                                <label>تاریخ تحویل:</label>
                                <div style="display: flex; gap: 10px;">
                                    <select data-group-key="${a}" class="multi-batch-day"><option value="">روز</option></select>
                                    <select data-group-key="${a}" class="multi-batch-month"><option value="">ماه</option></select>
                                    <select data-group-key="${a}" class="multi-batch-year"><option value="">سال</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                `}),o.batchAssignmentList.innerHTML=l,document.querySelectorAll(".multi-batch-day, .multi-batch-month, .multi-batch-year").forEach(a=>{a.classList.contains("multi-batch-day")&&F(a,1,31),a.classList.contains("multi-batch-month")&&F(a,1,12),a.classList.contains("multi-batch-year")&&F(a,1403,1410)})}else{o.multiBatchAssignmentContainer.classList.add("hidden"),o.singleBatchAssignmentContainer.classList.remove("hidden"),o.assignBatchModalTitle.textContent="اختصاص کد بچ و زمان تحویل";const l=i[0]==="هودی"||i[0]==="بامبر"||i[0]==="دورس"?"K":"A";o.batchCodeInput.value=U(l)}F(o.batchDeliveryDay,1,31),F(o.batchDeliveryMonth,1,12),F(o.batchDeliveryYear,1403,1410),X(o.assignBatchModal)});const F=(t,n,e)=>{const r=t.value;let i=`<option value="">${t.id.includes("Day")?"روز":t.id.includes("Month")?"ماه":"سال"}</option>`;for(let l=n;l<=e;l++)i+=`<option value="${l}">${l}</option>`;t.innerHTML=i,t.value=r},U=(t,n=!1)=>{const r=new Date().toLocaleDateString("fa-IR-u-nu-latn").split("/"),i=parseInt(r[1],10),l=parseInt(r[2],10),a=`batchCounter${t}`,c=`batchMonth${t}`;if(s[c]!==i)if(!n)s[c]=i,s[a]=1;else return`${t}${l}${i}1`;const d=`${t}${l}${i}${s[a]}`;return n||s[a]++,d};o.batchConfirmBtn.addEventListener("click",()=>{let t=!0;if(o.singleBatchAssignmentContainer.classList.contains("hidden")){const n=Object.keys(S.groups),e={};if(n.forEach(r=>{const i=document.querySelector(`.multi-batch-day[data-group-key="${r}"]`).value,l=document.querySelector(`.multi-batch-month[data-group-key="${r}"]`).value,a=document.querySelector(`.multi-batch-year[data-group-key="${r}"]`).value,d=U(r==="هودی"||r==="بامبر"||r==="دورس"?"K":"A",!1);if(!i||!l||!a||!d){t=!1;return}e[r]={batchCode:d,deliveryDate:`${a}/${l}/${i}`}}),!t){g("لطفا تاریخ تحویل را برای همه گروه‌ها مشخص کنید.","error");return}Object.keys(e).forEach(r=>{const i=e[r],l=S.groups[r];s.productionBatches[i.batchCode]?s.productionBatches[i.batchCode].logIds.push(...l):s.productionBatches[i.batchCode]={code:i.batchCode,creationDate:new Date().toISOString(),deliveryDate:i.deliveryDate,status:"inprogress",logIds:l,stages:{},productGroup:r,manualMaterials:[]},l.forEach(a=>{const c=s.productionLog.find(d=>d.logId===a);c&&(c.batchCode=i.batchCode,c.deliveryDate=i.deliveryDate,c.status=p.IN_PRODUCTION)})})}else{const n=o.batchDeliveryDay.value,e=o.batchDeliveryMonth.value,r=o.batchDeliveryYear.value;if(!n||!e||!r){g("لطفا تاریخ تحویل را کامل مشخص کنید.","error");return}const i=`${r}/${e}/${n}`,l=o.batchCodeInput.value;s.productionBatches[l]={code:l,creationDate:new Date().toISOString(),deliveryDate:i,status:"inprogress",logIds:S.logIds,stages:{},productGroup:Object.keys(S.groups)[0],manualMaterials:[]},S.logIds.forEach(a=>{const c=s.productionLog.find(d=>d.logId===a);c&&(c.batchCode=l,c.deliveryDate=i,c.status=p.IN_PRODUCTION)})}f(),D(o.assignBatchModal),g("کد بچ با موفقیت به آیتم‌ها اختصاص داده شد.")}),o.clearReportFiltersBtn.addEventListener("click",()=>{o.reportFileFilter.value="",o.reportStatusFilter.value="",o.reportGroupFilter.value="",o.reportColorFilter.value="",o.reportSizeFilter.value="",o.reportBatchFilter.value="",o.reportSkuSearch.value="",o.reportBatchSearch.value="",z()}),o.exportReportBtn.addEventListener("click",()=>{const t=o.reportTableContainer.querySelector("table");if(!t){g("جدولی برای خروجی گرفتن وجود ندارد.","error");return}const n=[],e=[...t.querySelectorAll("thead th")].map(l=>l.innerText).slice(1,-1);n.push(e),t.querySelectorAll("tbody tr").forEach(l=>{const a=[...l.querySelectorAll("td")].map(c=>c.innerText).slice(1,-1);n.push(a)});const r=XLSX.utils.aoa_to_sheet(n),i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,r,"Report"),XLSX.writeFile(i,"Comprehensive_Report.xlsx")});const it=()=>{const t=s.productionLog.filter(a=>a.status===p.PRINTING||a.status===p.PRINTED),e=[...new Set(t.map(a=>a.sourceFileId))].map(a=>{if(a==="manual")return{id:"manual",name:"کارمزدی"};const c=s.files[a];return c?{id:a,name:`(${c.shortId}) ${c.name}`}:null}).filter(Boolean);o.printingFileFilter.innerHTML='<option value="">همه فایل‌ها</option>'+e.map(a=>`<option value="${a.id}">${a.name}</option>`).join("");const r=[...new Set(t.map(a=>a.productGroup))];o.printingGroupFilter.innerHTML='<option value="">همه گروه‌ها</option>'+r.map(a=>`<option>${a}</option>`).join("");const i=[...new Set(t.map(a=>a.color))];o.printingColorFilter.innerHTML='<option value="">همه رنگ‌ها</option>'+i.map(a=>`<option>${a}</option>`).join("");const l=[...new Set(t.map(a=>a.size))];o.printingSizeFilter.innerHTML='<option value="">همه سایزها</option>'+l.map(a=>`<option>${a}</option>`).join(""),W()},W=()=>{const t=o.printingFileFilter.value,n=o.printingGroupFilter.value,e=o.printingColorFilter.value,r=o.printingSizeFilter.value,i=s.productionLog.filter(l=>(l.status===p.PRINTING||l.status===p.PRINTED)&&(!t||l.sourceFileId===t)&&(!n||l.productGroup===n)&&(!e||l.color===e)&&(!r||l.size===r));bt(i)};[o.printingFileFilter,o.printingGroupFilter,o.printingColorFilter,o.printingSizeFilter].forEach(t=>t.addEventListener("change",W));const bt=t=>{let n=`<table><thead><tr>
            <th><input type="checkbox" id="selectAllPrinting"></th>
            <th>کد بچ</th><th>کد طرح</th><th>محصول</th><th>رنگ</th><th>سایز</th>
            <th>تعداد</th><th>وضعیت چاپ</th><th>منبع</th>
        </tr></thead><tbody>`;t.length>0?t.forEach(e=>{var i;const r=e.sourceFileId==="manual"?"کارمزدی":((i=s.files[e.sourceFileId])==null?void 0:i.name)||"نامشخص";n+=`<tr>
                    <td><input type="checkbox" class="printing-checkbox" data-id="${e.logId}"></td>
                    <td>${e.batchCode||"-"}</td>
                    <td>${e.sku}</td>
                    <td>${e.productName}</td>
                    <td>${e.color}</td>
                    <td>${e.size}</td>
                    <td>${e.quantity}</td>
                    <td>${V(e.status)}</td>
                    <td>${e.sourceFileShortId} (${r})</td>
                </tr>`}):n+='<tr><td colspan="9">هیچ آیتمی در صف چاپ وجود ندارد.</td></tr>',o.printingTableContainer.innerHTML=n+"</tbody></table>"};o.clearPrintingFiltersBtn.addEventListener("click",()=>{o.printingFileFilter.value="",o.printingGroupFilter.value="",o.printingColorFilter.value="",o.printingSizeFilter.value="",W()}),o.printingTableContainer.addEventListener("change",t=>{t.target.id==="selectAllPrinting"&&document.querySelectorAll(".printing-checkbox").forEach(n=>n.checked=t.target.checked)}),o.printingBulkUpdateBtn.addEventListener("click",()=>{const t=[...document.querySelectorAll(".printing-checkbox:checked")].map(e=>e.dataset.id);if(t.length===0){g("هیچ آیتمی انتخاب نشده است.","error");return}let n=0;t.forEach(e=>{const r=s.productionLog.find(i=>i.logId===e);r&&r.status===p.PRINTING&&(r.status=p.PRINTED,n++)}),n>0?(f(),g(`${n} آیتم به "چاپ شده" تغییر وضعیت یافت.`)):g('هیچ آیتمی در وضعیت "در دست چاپ" برای تغییر انتخاب نشده بود.',"warning")}),o.exportPrintingBtn.addEventListener("click",()=>{const t=o.printingTableContainer.querySelector("table");if(!t)return;const n=[];t.querySelectorAll("tbody tr").forEach(e=>{const r=e.querySelectorAll("td");r.length>1&&n.push({"کد طرح":r[2].innerText,محصول:r[3].innerText,رنگ:r[4].innerText,سایز:r[5].innerText,تعداد:r[6].innerText,وضعیت:r[7].innerText,منبع:r[8].innerText,"کد بچ":r[1].innerText})}),n.length>0&&tt(n,"Printing_List.xlsx")}),o.printPrintingBtn.addEventListener("click",()=>{const n=o.printingTableContainer.querySelector("table");if(!n)return;const e={};n.querySelectorAll("tbody tr").forEach(l=>{const a=l.querySelectorAll("td");if(a.length>1){const c=a[3].innerText.split(" ")[0]||"سایر",d=a[4].innerText,u=a[5].innerText,h=parseInt(a[6].innerText,10),m=`${c}|${d}|${u}`;e[m]=(e[m]||0)+h}});let r=`
            <style>
                body { font-family: 'Vazirmatn', sans-serif; direction: rtl; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }
                th { background-color: #f2f2f2; }
                h1 { text-align: center; }
            </style>
            <h1>لیست چاپ - ${new Date().toLocaleDateString("fa-IR")}</h1>
            <table><thead><tr><th>گروه محصول</th><th>رنگ</th><th>سایز</th><th>تعداد کل</th></tr></thead><tbody>`;Object.keys(e).sort().forEach(l=>{const[a,c,d]=l.split("|"),u=e[l];r+=`<tr><td>${a}</td><td>${c}</td><td>${d}</td><td>${u}</td></tr>`}),r+="</tbody></table>";const i=window.open("","","height=600,width=800");i.document.write(r),i.document.close(),i.print()});const st=(t=!1)=>{t||R.clear(),Q(!0)},Q=(t=!1)=>{const n=o.trackingSearchInput.value.toLowerCase(),e=o.trackingDateFilter.value,r=o.trackingGroupFilter.value,i=o.trackingStatusFilter.value;if(G=Object.values(s.productionBatches).filter(l=>{const a=l.creationDate.split("T")[0];return(!n||l.code.toLowerCase().includes(n))&&(!e||a===e)&&(!r||l.productGroup===r)&&(!i||l.status===i)}),G.sort((l,a)=>a.creationDate.localeCompare(l.creationDate)),t){const l=[...new Set(Object.values(s.productionBatches).map(a=>a.productGroup))];o.trackingGroupFilter.innerHTML='<option value="">همه</option>'+l.map(a=>`<option>${a}</option>`).join("")}ft(G)};[o.trackingSearchInput,o.trackingDateFilter,o.trackingGroupFilter,o.trackingStatusFilter].forEach(t=>t.addEventListener("input",()=>Q()));const ft=t=>{let n=`<table><thead><tr>
            <th>کد بچ</th><th>گروه محصول</th><th>تاریخ ایجاد</th><th>تاریخ تحویل</th><th>تعداد کل</th><th>وضعیت</th><th>مدت زمان</th><th>عملیات</th>
        </tr></thead><tbody>`;t.length>0?t.forEach(e=>{const r=(e.logIds||[]).reduce((h,m)=>{const b=s.productionLog.find(y=>y.logId===m);return h+(b?b.quantity:0)},0),i=new Date(e.creationDate),l=e.completionDate?new Date(e.completionDate):new Date,a=Math.abs(l-i),c=Math.floor(a/(1e3*60*60*24)),d=Math.floor(a%(1e3*60*60*24)/(1e3*60*60)),u=e.status==="completed"?`${c} روز و ${d} ساعت`:"درحال انجام";n+=`
                    <tr data-batch-code="${e.code}">
                        <td><strong>${e.code}</strong></td>
                        <td>${e.productGroup}</td>
                        <td>${new Date(e.creationDate).toLocaleString("fa-IR")}</td>
                        <td>${e.deliveryDate}</td>
                        <td>${r}</td>
                        <td>${V(e.status==="completed"?p.DONE:e.status==="cancelled"?p.CANCELLED:p.IN_PROGRESS)}</td>
                        <td>${u}</td>
                        <td>
                             <button class="btn-primary btn-sm" data-action="details">جزئیات</button>
                             <button class="btn-inventory btn-sm" data-action="print">چاپ</button>
                              ${e.status!=="completed"&&e.status!=="cancelled"?'<button class="btn-success btn-sm" data-action="complete">تکمیل بچ</button>':""}
                             ${e.status!=="completed"&&e.status!=="cancelled"?'<button class="btn-warning btn-sm" data-action="cancel">کنسل</button>':""}
                             ${e.status!=="completed"&&e.status!=="cancelled"?'<button class="btn-danger btn-sm" data-action="removeBatchCode">حذف بچ</button>':""}
                              ${e.status==="cancelled"?'<button class="btn-danger btn-sm" data-action="delete">حذف</button>':""}
                        </td>
                    </tr>
                    <tr class="details-row ${R.has(e.code)?"visible":""}" data-details-for="${e.code}">
                        <td colspan="8" class="details-cell"><div class="details-content">${Y(e)}</div></td>
                    </tr>`}):n+='<tr><td colspan="8">هیچ بچ تولیدی با این فیلترها یافت نشد.</td></tr>',o.batchTrackingTableContainer.innerHTML=n+"</tbody></table>"},Y=t=>{const n=(t.logIds||[]).map(d=>s.productionLog.find(u=>u.logId===d)).filter(Boolean);let e='<div style="max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px;"><ul>';n.forEach(d=>{e+=`<li>${d.productName} - ${d.color} - ${d.size} (تعداد: ${d.quantity})</li>`}),e+="</ul></div>";let r="<ul>";const i={};n.forEach(d=>{const u=s.bom[d.productGroup];u&&Object.keys(u).forEach(h=>{Object.keys(u[h]).forEach(m=>{const b=u[h][m],y=`${h}|${m}`;i[y]=(i[y]||0)+d.quantity*b})})}),Object.keys(i).length>0?Object.keys(i).forEach(d=>{var y,I;const[u,h]=d.split("|"),m=i[d],b=((I=(y=s.materials[u])==null?void 0:y[h])==null?void 0:I.unit)||"";r+=`<li>${u} - ${h}: ${m.toFixed(2)} ${b}</li>`}):r+="<li>استاندارد مصرفی برای این گروه محصول تعریف نشده است.</li>",r+="</ul>";let l=`<div id="manualMaterialsList-${t.code}">`;t.manualMaterials&&t.manualMaterials.length>0?(l+="<ul>",t.manualMaterials.forEach((d,u)=>{l+=`<li>${d.name} (${d.color}): ${d.quantity} ${d.unit} <button class="btn-danger btn-sm" data-action="deleteManualMaterial" data-batch-code="${t.code}" data-index="${u}">X</button></li>`}),l+="</ul>"):l+="<p>هیچ خرج کاری ثبت نشده است.</p>",l+="</div>";const a=`
            <div class="filters" style="padding: 10px; margin-top: 15px; display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 10px;">
                <input type="text" id="manualMatName-${t.code}" placeholder="نام خرج کار" style="padding: 8px;">
                <input type="text" id="manualMatColor-${t.code}" placeholder="رنگ" style="padding: 8px;">
                <input type="number" id="manualMatQty-${t.code}" placeholder="مقدار" style="padding: 8px;">
                <input type="text" id="manualMatUnit-${t.code}" placeholder="واحد" style="padding: 8px;">
                <button class="btn-secondary btn-sm" data-action="addManualMaterial" data-batch-code="${t.code}" style="padding: 8px 12px;">افزودن</button>
            </div>`;let c='<ul class="stage-checklist">';return Object.keys(P).forEach(d=>{c+=`<li><input type="checkbox" data-batch-code="${t.code}" data-stage="${d}" ${t.stages[d]?"checked":""}> ${P[d]}</li>`}),c+="</ul>",`<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                    <div>
                        <h4>آیتم‌های بچ</h4>
                        ${e}
                        <h4>مراحل تولید</h4>
                        ${c}
                    </div>
                    <div>
                        <h4>مصرف مواد اولیه</h4>
                        <div style="border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; background: var(--bg-primary);">
                            <h5>استاندارد</h5>
                            ${r}
                            <h5 style="margin-top: 20px;">خرج کار دستی</h5>
                            ${l}
                            ${a}
                        </div>
                    </div>
                </div>`};o.batchTrackingTableContainer.addEventListener("click",t=>{var i,l;const n=t.target.closest("button");if(!n)return;const e=n.dataset.action,r=((i=n.closest("tr[data-batch-code]"))==null?void 0:i.dataset.batchCode)||n.dataset.batchCode;if(r)switch(e){case"details":{document.querySelector(`.details-row[data-details-for="${r}"]`).classList.toggle("visible")?R.add(r):R.delete(r);break}case"complete":{k("تکمیل بچ تولید",`آیا از تکمیل بچ "${r}" اطمینان دارید؟`,()=>{const a=s.productionBatches[r];a&&(a.status="completed",a.completionDate=new Date().toISOString(),Object.keys(P).forEach(c=>a.stages[c]=!0),(a.logIds||[]).forEach(c=>{const d=s.productionLog.find(u=>u.logId===c);d&&(d.status=p.DONE)}),f(),g(`بچ ${r} تکمیل شد.`))});break}case"cancel":{k("کنسل کردن بچ",`آیا از کنسل کردن بچ "${r}" اطمینان دارید؟ وضعیت تمام آیتم های آن به "ابطال" تغییر خواهد کرد.`,()=>{const a=s.productionBatches[r];a&&(a.status="cancelled",(a.logIds||[]).forEach(c=>{const d=s.productionLog.find(u=>u.logId===c);d&&(d.status=p.CANCELLED)}),f(),g(`بچ ${r} کنسل شد.`))});break}case"delete":{k("حذف بچ کنسل شده",`آیا از حذف بچ کنسل شده "${r}" از لیست رهگیری اطمینان دارید؟ (سوابق آیتم‌ها باقی می‌ماند)`,()=>{delete s.productionBatches[r],f(),g(`بچ ${r} حذف شد.`)});break}case"removeBatchCode":{k("حذف کد بچ",`آیا از حذف کد بچ "${r}" از آیتم‌های مرتبط اطمینان دارید؟ وضعیت آیتم‌ها به "درحال انجام" بازمی‌گردد.`,()=>{const a=s.productionBatches[r];a&&((a.logIds||[]).forEach(c=>{const d=s.productionLog.find(u=>u.logId===c);d&&(d.batchCode=null,d.deliveryDate=null,d.status!==p.PRINTING&&d.status!==p.PRINTED&&(d.status=p.IN_PROGRESS))}),delete s.productionBatches[r],f(),g(`کد بچ ${r} حذف و آیتم‌ها به‌روزرسانی شدند.`))});break}case"print":{const a=s.productionBatches[r];a&&It(a);break}case"addManualMaterial":{const a=document.getElementById(`manualMatName-${r}`).value.trim(),c=document.getElementById(`manualMatColor-${r}`).value.trim(),d=parseFloat(document.getElementById(`manualMatQty-${r}`).value),u=document.getElementById(`manualMatUnit-${r}`).value.trim();if(a&&!isNaN(d)&&d>0&&u){const h=s.productionBatches[r];if(h){h.manualMaterials||(h.manualMaterials=[]),h.manualMaterials.push({name:a,color:c||"نامشخص",quantity:d,unit:u}),f();const m=document.querySelector(`.details-row[data-details-for="${r}"] .details-content`);m&&(m.innerHTML=Y(h))}}else g("لطفا نام، مقدار و واحد خرج کار را به درستی وارد کنید.","error");break}case"deleteManualMaterial":{const a=parseInt(n.dataset.index,10),c=s.productionBatches[r];if(c&&((l=c.manualMaterials)!=null&&l[a])){c.manualMaterials.splice(a,1),f();const d=document.querySelector(`.details-row[data-details-for="${r}"] .details-content`);d&&(d.innerHTML=Y(c))}break}}});const It=t=>{const n=(t.logIds||[]).map(u=>s.productionLog.find(h=>h.logId===u)).filter(Boolean),e={};n.forEach(u=>{const h=`${u.productGroup}|${u.color}|${u.size}`;e[h]=(e[h]||0)+u.quantity});let r="<table><thead><tr><th>گروه</th><th>رنگ</th><th>سایز</th><th>تعداد</th></tr></thead><tbody>",i=0;Object.keys(e).sort().forEach(u=>{const[h,m,b]=u.split("|"),y=e[u];i+=y,r+=`<tr><td>${h}</td><td>${m}</td><td>${b}</td><td>${y}</td></tr>`}),r+=`<tr><td colspan="3"><strong>جمع کل</strong></td><td><strong>${i}</strong></td></tr></tbody></table>`;let l='<div class="checklist"><h4>چک لیست تولید</h4><ul>';Object.values(P).forEach(u=>{l+=`<li><span class="checkbox"></span>${u}</li>`}),l+="</ul></div>";let a="<h4>مصرف مواد</h4>";const c={};n.forEach(u=>{const h=s.bom[u.productGroup];h&&Object.keys(h).forEach(m=>Object.keys(h[m]).forEach(b=>{const y=`${m}|${b}`;c[y]=(c[y]||0)+u.quantity*h[m][b]}))}),a+="<h5>استاندارد</h5><ul>",Object.keys(c).forEach(u=>{var b,y;const[h,m]=u.split("|");a+=`<li>${h} - ${m}: ${c[u].toFixed(2)} ${((y=(b=s.materials[h])==null?void 0:b[m])==null?void 0:y.unit)||""}</li>`}),a+="</ul>",t.manualMaterials&&t.manualMaterials.length>0&&(a+="<h5>خرج کار دستی</h5><ul>",t.manualMaterials.forEach(u=>{a+=`<li>${u.name} (${u.color}): ${u.quantity} ${u.unit}</li>`}),a+="</ul>");const d=window.open("","","height=800,width=1000");d.document.write(`
            <html><head><title>چاپ دستور تولید</title>
            <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Vazirmatn', sans-serif; direction: rtl; padding: 20px; }
                .print-container { border: 2px solid #333; border-radius: 15px; padding: 30px; }
                h1 { text-align: center; font-size: 32px; margin-bottom: 5px; }
                .batch-code { text-align: center; font-size: 64px; font-weight: bold; margin: 10px 0 30px; letter-spacing: 2px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; font-size: 18px; }
                table { width: 100%; border-collapse: collapse; font-size: 16px; margin-bottom: 20px; }
                th, td { border: 1px solid #ccc; padding: 12px; text-align: right; }
                th { background-color: #f2f2f2; }
                ul { padding-right: 20px; }
                .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 40px; }
                .checklist ul { list-style: none; padding: 0; }
                .checklist li { font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; }
                .checkbox { width: 25px; height: 25px; border: 2px solid #333; border-radius: 5px; margin-left: 15px; }
            </style>
            </head><body>
                <div class="print-container">
                    <h1>دستور تولید</h1>
                    <div class="batch-code">${t.code}</div>
                    <div class="info-grid">
                        <span><strong>تاریخ صدور:</strong> ${new Date(t.creationDate).toLocaleDateString("fa-IR")}</span>
                        <span><strong>تاریخ تحویل:</strong> ${t.deliveryDate}</span>
                    </div>
                    <div class="main-content">
                        <div>
                           <h4>لیست آیتم‌ها</h4>
                           ${r}
                           ${a}
                        </div>
                        ${l}
                    </div>
                </div>
            </body></html>`),d.document.close(),d.focus(),setTimeout(()=>{d.print()},500)};o.batchTrackingTableContainer.addEventListener("change",t=>{if(t.target.type==="checkbox"){const n=t.target.dataset.batchCode,e=t.target.dataset.stage,r=s.productionBatches[n];r&&(r.stages[e]=t.target.checked,f())}}),o.clearTrackingFiltersBtn.addEventListener("click",()=>{o.trackingSearchInput.value="",o.trackingDateFilter.value="",o.trackingGroupFilter.value="",o.trackingStatusFilter.value="",Q()}),o.exportTrackingBtn.addEventListener("click",()=>{const t=G.map(n=>{const e=(n.logIds||[]).reduce((r,i)=>{const l=s.productionLog.find(a=>a.logId===i);return r+(l?l.quantity:0)},0);return{"کد بچ":n.code,"گروه محصول":n.productGroup,"تاریخ ایجاد":new Date(n.creationDate).toLocaleString("fa-IR"),"تاریخ تحویل":n.deliveryDate,"تعداد کل":e,وضعیت:n.status}});t.length>0&&tt(t,"Tracking_Report.xlsx")})});
